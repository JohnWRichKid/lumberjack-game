<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Monad Lumberjack</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Arial Black', sans-serif;
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    color: white;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    user-select: none;
}
h1 {
    font-size: 28px;
    margin: 10px 0;
    background: linear-gradient(135deg, #f093fb, #f5576c);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
#main { display: flex; gap: 20px; align-items: flex-start; }

/* Game Area */
#game {
    width: 380px;
    height: 600px;
    background: linear-gradient(to bottom, #87CEEB, #98D1A8);
    border: 4px solid #5D4037;
    border-radius: 15px;
    position: relative;
    overflow: hidden;
}
#game.tournament-mode {
    border-color: #9c27b0;
    box-shadow: 0 0 30px rgba(156, 39, 176, 0.5);
}

/* Tree */
#trunk {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: 80px;
    width: 60px;
    height: 520px;
    background: linear-gradient(90deg, #5D4037 0%, #8D6E63 50%, #5D4037 100%);
    z-index: 10;
}

/* Branches */
.branch {
    position: absolute;
    left: 50%;
    width: 80px;
    height: 50px;
    z-index: 9;
}
.branch.left { transform: translateX(-30px) translateX(-100%); }
.branch.right { transform: translateX(30px); }
.branch-wood {
    position: absolute;
    bottom: 20px;
    width: 60px;
    height: 15px;
    background: linear-gradient(to bottom, #8D6E63, #5D4037);
}
.branch.left .branch-wood { right: 0; border-radius: 10px 0 0 10px; }
.branch.right .branch-wood { left: 0; border-radius: 0 10px 10px 0; }
.branch-leaves {
    position: absolute;
    bottom: 8px;
    width: 55px;
    height: 45px;
    background: radial-gradient(ellipse, #4CAF50 0%, #2E7D32 100%);
    border-radius: 50%;
}
.branch.left .branch-leaves { left: 0; }
.branch.right .branch-leaves { right: 0; }

/* Ground */
#ground {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 80px;
    background: linear-gradient(to bottom, #7CB342, #558B2F);
    z-index: 15;
}

/* Player */
#player {
    position: absolute;
    bottom: 85px;
    width: 60px;
    height: 80px;
    z-index: 20;
    transition: left 0.05s;
}
#player.left { left: 60px; }
#player.right { left: 260px; }
.p-head {
    width: 35px;
    height: 35px;
    background: #FFCCBC;
    border-radius: 50%;
    border: 3px solid #5D4037;
    margin: 0 auto;
}
.p-body {
    width: 28px;
    height: 30px;
    background: #D32F2F;
    margin: 2px auto 0;
    border-radius: 5px;
}
.p-legs {
    width: 24px;
    height: 15px;
    background: #1976D2;
    margin: 0 auto;
    border-radius: 0 0 5px 5px;
}
.p-axe {
    position: absolute;
    top: 25px;
    font-size: 28px;
}
#player.left .p-axe { right: -10px; transform: scaleX(-1); }
#player.right .p-axe { left: -10px; }

/* HUD */
#hud {
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    z-index: 50;
}
#score {
    font-size: 48px;
    font-weight: bold;
    text-shadow: 3px 3px 0 #5D4037;
}
#timebar {
    width: 180px;
    height: 15px;
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
    margin-top: 5px;
    overflow: hidden;
}
#timefill {
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    transition: width 0.1s;
}
#timefill.warning { background: linear-gradient(90deg, #FF9800, #FFC107); }
#timefill.danger { background: linear-gradient(90deg, #f44336, #FF5722); }

/* Tournament badge */
#badge {
    position: absolute;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #9c27b0, #e91e63);
    padding: 8px 20px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: bold;
    display: none;
    z-index: 50;
}
#badge.show { display: block; }

/* Game timer for tournament */
#gameTimer {
    position: absolute;
    top: 55px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.8);
    padding: 5px 15px;
    border-radius: 15px;
    font-size: 20px;
    color: #feca57;
    display: none;
    z-index: 50;
}
#gameTimer.show { display: block; }
#gameTimer.urgent { color: #f44336; animation: pulse 0.5s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

/* Tap zones */
.tap-zone {
    position: absolute;
    top: 0;
    width: 50%;
    height: 100%;
    z-index: 30;
    cursor: pointer;
}
.tap-zone.left { left: 0; }
.tap-zone.right { right: 0; }

/* Start overlay */
#startScreen {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 100;
    text-align: center;
}
#startScreen.hidden { display: none; }
#startScreen h2 { font-size: 28px; margin-bottom: 15px; }
#startScreen p { font-size: 16px; margin: 5px 0; opacity: 0.9; }
#startMsg {
    margin-top: 25px;
    font-size: 18px;
    color: #feca57;
    animation: blink 1.5s infinite;
}
@keyframes blink { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }

/* Game over */
#gameOver {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 100;
    text-align: center;
}
#gameOver.show { display: flex; }
#gameOver h2 { font-size: 28px; color: #f44336; margin-bottom: 10px; }
#gameOver.record h2 { color: #feca57; }
#finalScore { font-size: 64px; font-weight: bold; }
#gameOverMsg { font-size: 16px; color: #feca57; margin: 10px 0; }
#submitMsg { font-size: 14px; color: #8BC34A; margin: 10px 0; }
#playAgainBtn {
    margin-top: 20px;
    padding: 15px 40px;
    font-size: 18px;
    font-weight: bold;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    border-radius: 10px;
    color: white;
    cursor: pointer;
}

/* Side Panel */
#side { width: 280px; }
.box {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
}

/* Mode toggle */
.mode-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}
.mode-btn {
    flex: 1;
    padding: 12px;
    font-size: 14px;
    font-weight: bold;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    background: rgba(255,255,255,0.1);
    color: rgba(255,255,255,0.5);
    transition: all 0.2s;
}
.mode-btn.active {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}
.mode-btn.tournament.active {
    background: linear-gradient(135deg, #9c27b0, #e91e63);
}

/* Wallet */
#connectBtn {
    width: 100%;
    padding: 15px;
    font-size: 16px;
    font-weight: bold;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    border-radius: 10px;
    color: white;
    cursor: pointer;
}
#connectBtn.connected {
    background: linear-gradient(135deg, #11998e, #38ef7d);
}
#walletInfo { display: none; margin-top: 15px; text-align: center; }
#walletInfo.show { display: block; }
.balance { font-size: 24px; font-weight: bold; color: #8BC34A; margin: 10px 0; }
.address { font-size: 11px; opacity: 0.6; cursor: pointer; word-break: break-all; }
.wallet-actions { margin-top: 15px; }
.wallet-row { display: flex; gap: 8px; margin-bottom: 8px; }
.wallet-row input {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
}
.wallet-row button {
    padding: 10px 15px;
    font-size: 14px;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
}
.btn-deposit { background: #4CAF50; }
.btn-send { background: #FF9800; }
.quick-amounts { display: flex; gap: 5px; }
.quick-amounts button {
    flex: 1;
    padding: 8px;
    font-size: 12px;
    background: rgba(255,255,255,0.1);
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
}

/* Tournament box */
.tournament-box {
    background: linear-gradient(135deg, rgba(156,39,176,0.2), rgba(233,30,99,0.2));
    border: 1px solid rgba(156,39,176,0.4);
}
.tournament-box h3 {
    color: #e91e63;
    font-size: 16px;
    margin-bottom: 10px;
}
#phaseDisplay {
    text-align: center;
    padding: 10px;
    border-radius: 8px;
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 10px;
}
#phaseDisplay.signup { background: rgba(76,175,80,0.3); color: #8BC34A; }
#phaseDisplay.play { background: rgba(233,30,99,0.3); color: #e91e63; }
#timerDisplay {
    font-size: 48px;
    font-weight: bold;
    text-align: center;
    color: #feca57;
    margin: 10px 0;
}
.stats-row {
    display: flex;
    justify-content: space-around;
    margin: 15px 0;
    text-align: center;
}
.stat-item .value { font-size: 24px; font-weight: bold; color: #8BC34A; }
.stat-item .label { font-size: 11px; opacity: 0.7; }
#joinBtn {
    width: 100%;
    padding: 15px;
    font-size: 16px;
    font-weight: bold;
    background: linear-gradient(135deg, #9c27b0, #e91e63);
    border: none;
    border-radius: 10px;
    color: white;
    cursor: pointer;
}
#joinBtn:disabled { opacity: 0.5; cursor: not-allowed; }
#joinBtn.joined { background: linear-gradient(135deg, #4CAF50, #8BC34A); }
#myScoreBox {
    display: none;
    margin-top: 10px;
    padding: 10px;
    background: rgba(0,0,0,0.3);
    border-radius: 8px;
    text-align: center;
}
#myScoreBox.show { display: block; }
#lastResultBox {
    display: none;
    margin-top: 15px;
    padding: 12px;
    background: rgba(76,175,80,0.2);
    border-radius: 8px;
    text-align: center;
}
#lastResultBox.show { display: block; }
.winner-text { color: #8BC34A; font-weight: bold; font-size: 16px; margin: 5px 0; }
.prize-text { color: #feca57; }

/* Info */
.info-text {
    font-size: 11px;
    opacity: 0.6;
    text-align: center;
    line-height: 1.5;
}

@media (max-width: 700px) {
    #main { flex-direction: column; align-items: center; }
    #side { width: 380px; }
}
</style>
</head>
<body>

<h1>ü™ì MONAD LUMBERJACK</h1>

<div id="main">
    <div id="game">
        <div id="trunk"></div>
        <div id="ground"></div>
        <div id="player" class="left">
            <div class="p-head"></div>
            <div class="p-body"></div>
            <div class="p-legs"></div>
            <div class="p-axe">ü™ì</div>
        </div>
        <div id="hud">
            <div id="score">0</div>
            <div id="timebar"><div id="timefill"></div></div>
        </div>
        <div id="badge">üèÜ TOURNAMENT MODE</div>
        <div id="gameTimer">1:00</div>
        <div class="tap-zone left"></div>
        <div class="tap-zone right"></div>
        
        <div id="startScreen">
            <h2>ü™ì MONAD LUMBERJACK</h2>
            <p>‚¨ÖÔ∏è Tap LEFT side = chop left</p>
            <p>‚û°Ô∏è Tap RIGHT side = chop right</p>
            <p>üåø Avoid the branches!</p>
            <div id="startMsg">CONNECT WALLET TO PLAY</div>
        </div>
        
        <div id="gameOver">
            <h2>GAME OVER</h2>
            <div id="finalScore">0</div>
            <div id="gameOverMsg">Best: 0</div>
            <div id="submitMsg"></div>
            <button id="playAgainBtn">PLAY AGAIN</button>
        </div>
    </div>
    
    <div id="side">
        <div class="mode-toggle">
            <button class="mode-btn active" id="practiceBtn">üéÆ PRACTICE</button>
            <button class="mode-btn tournament" id="tournamentBtn">üèÜ TOURNAMENT</button>
        </div>
        
        <div class="box">
            <button id="connectBtn">Connect Wallet</button>
            <div id="walletInfo">
                <div>Game Wallet</div>
                <div class="balance"><span id="balanceAmount">0</span> MON</div>
                <div class="address" id="walletAddress">-</div>
                <div class="wallet-actions">
                    <div class="wallet-row">
                        <input type="number" id="depositAmount" placeholder="Amount">
                        <button class="btn-deposit" id="depositBtn">Deposit</button>
                    </div>
                    <div class="quick-amounts">
                        <button data-amount="1">1</button>
                        <button data-amount="5">5</button>
                        <button data-amount="10">10</button>
                        <button data-amount="25">25</button>
                    </div>
                    <div class="wallet-row" style="margin-top: 10px;">
                        <input type="text" id="sendAddress" placeholder="0x..." style="flex: 2;">
                        <input type="number" id="sendAmount" placeholder="Amt" style="flex: 1;">
                        <button class="btn-send" id="sendBtn">Send</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="box tournament-box">
            <h3>üèÜ TOURNAMENT #<span id="tournamentId">1</span></h3>
            <div id="phaseDisplay" class="signup">üìù SIGNUP PHASE</div>
            <div id="timerDisplay">1:00</div>
            <div class="stats-row">
                <div class="stat-item">
                    <div class="value" id="prizePool">0</div>
                    <div class="label">Prize (MON)</div>
                </div>
                <div class="stat-item">
                    <div class="value" id="playerCount">0</div>
                    <div class="label">Players</div>
                </div>
                <div class="stat-item">
                    <div class="value" id="highScore">0</div>
                    <div class="label">High Score</div>
                </div>
            </div>
            <button id="joinBtn" disabled>Join Tournament (10 MON)</button>
            <div id="myScoreBox">Your Best: <span id="myScore">0</span></div>
            <div id="lastResultBox">
                <div>üéâ Last Winner</div>
                <div class="winner-text" id="lastWinner">-</div>
                <div class="prize-text" id="lastPrize"></div>
            </div>
        </div>
        
        <div class="info-text">
            üìù Signup (1 min) ‚Üí üéÆ Play (1 min) ‚Üí üèÜ Winner takes all!<br>
            Ties split the pot. Solo player gets refunded.
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
// ===================
// CONFIG
// ===================
const CONTRACT_ADDRESS = "0xaa2E51f7f97c9BdE340BDFbB5316C6Cc528a08A8";
const RPC_URL = "https://testnet-rpc.monad.xyz";
const CHAIN_ID = "0x279f"; // 10143
const EXPLORER = "https://testnet.monadexplorer.com";

const ABI = [
    "function tick() public",
    "function joinTournament() external payable",
    "function submitScore(uint256 score) external",
    "function getInfo() external view returns (uint256 tournamentId, uint8 phase, uint256 timeLeft, uint256 prizePool, uint256 playerCount, uint256 highScore)",
    "function amIRegistered() external view returns (bool)",
    "function getMyScore() external view returns (uint256)",
    "function getLastResult() external view returns (address[] winners, uint256 highScore, uint256 prize, uint256 playerCount)"
];

// ===================
// STATE
// ===================
let provider, signer, userAddress, burnerWallet, contract;
let gameMode = "practice"; // "practice" or "tournament"
let currentPhase = 0; // 0 = signup, 1 = play
let isRegistered = false;
let myTournamentScore = 0;
let playPhaseEndTime = 0;

let gameRunning = false;
let score = 0;
let highScore = parseInt(localStorage.getItem("lumberjackHighScore") || "0");
let timeLeft = 100;
let branches = [];
let canRestart = true;

// ===================
// DOM ELEMENTS
// ===================
const $ = id => document.getElementById(id);
const gameEl = $("game");
const playerEl = $("player");
const scoreEl = $("score");
const timefillEl = $("timefill");
const startScreenEl = $("startScreen");
const startMsgEl = $("startMsg");
const gameOverEl = $("gameOver");
const finalScoreEl = $("finalScore");
const gameOverMsgEl = $("gameOverMsg");
const submitMsgEl = $("submitMsg");
const badgeEl = $("badge");
const gameTimerEl = $("gameTimer");
const connectBtnEl = $("connectBtn");
const walletInfoEl = $("walletInfo");
const balanceEl = $("balanceAmount");
const addressEl = $("walletAddress");
const joinBtnEl = $("joinBtn");
const phaseDisplayEl = $("phaseDisplay");
const timerDisplayEl = $("timerDisplay");
const prizePoolEl = $("prizePool");
const playerCountEl = $("playerCount");
const highScoreEl = $("highScore");
const myScoreBoxEl = $("myScoreBox");
const myScoreEl = $("myScore");
const lastResultBoxEl = $("lastResultBox");
const lastWinnerEl = $("lastWinner");
const lastPrizeEl = $("lastPrize");
const tournamentIdEl = $("tournamentId");

// ===================
// UTILS
// ===================
function shortAddress(addr) {
    return addr.slice(0, 6) + "..." + addr.slice(-4);
}

function getBurnerWallet() {
    let pk = localStorage.getItem("lumberjackBurnerPK");
    if (!pk) {
        pk = ethers.Wallet.createRandom().privateKey;
        localStorage.setItem("lumberjackBurnerPK", pk);
    }
    return new ethers.Wallet(pk, new ethers.providers.JsonRpcProvider(RPC_URL));
}

// ===================
// WALLET & CONTRACT
// ===================
async function updateBalance() {
    if (!burnerWallet) return;
    try {
        const balance = await burnerWallet.getBalance();
        const bal = parseFloat(ethers.utils.formatEther(balance));
        balanceEl.textContent = bal.toFixed(3);
        
        // Update join button state
        joinBtnEl.disabled = bal < 10 || isRegistered || currentPhase !== 0;
        
        updateStartMessage();
    } catch (e) {
        console.error("Balance error:", e);
    }
}

async function updateTournamentInfo() {
    if (!contract) return;
    
    try {
        // Call tick to advance phases if needed
        await contract.tick().catch(() => {});
        
        // Get tournament info
        const info = await contract.getInfo();
        const tournamentId = info.tournamentId.toNumber();
        const phase = info.phase;
        const timeLeft = info.timeLeft.toNumber();
        const prizePool = parseFloat(ethers.utils.formatEther(info.prizePool));
        const players = info.playerCount.toNumber();
        const high = info.highScore.toNumber();
        
        // Update UI
        tournamentIdEl.textContent = tournamentId;
        currentPhase = phase;
        
        if (phase === 0) {
            phaseDisplayEl.className = "signup";
            phaseDisplayEl.textContent = "üìù SIGNUP PHASE";
            playPhaseEndTime = 0;
        } else {
            phaseDisplayEl.className = "play";
            phaseDisplayEl.textContent = "üéÆ PLAY PHASE";
            // Calculate when play phase ends
            playPhaseEndTime = Date.now() + (timeLeft * 1000);
        }
        
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        timerDisplayEl.textContent = mins + ":" + (secs < 10 ? "0" : "") + secs;
        
        prizePoolEl.textContent = prizePool.toFixed(0);
        playerCountEl.textContent = players;
        highScoreEl.textContent = high;
        
        // Check registration
        isRegistered = await contract.amIRegistered();
        joinBtnEl.textContent = isRegistered ? "‚úì Joined!" : "Join Tournament (10 MON)";
        joinBtnEl.classList.toggle("joined", isRegistered);
        
        // Get my score
        if (isRegistered) {
            myTournamentScore = (await contract.getMyScore()).toNumber();
            myScoreEl.textContent = myTournamentScore;
            myScoreBoxEl.classList.add("show");
        } else {
            myScoreBoxEl.classList.remove("show");
        }
        
        // Get last result
        const lastResult = await contract.getLastResult();
        const winners = lastResult.winners;
        const lastHS = lastResult.highScore.toNumber();
        const lastPrize = parseFloat(ethers.utils.formatEther(lastResult.prize));
        const lastPlayers = lastResult.playerCount.toNumber();
        
        if (lastPlayers > 0) {
            lastResultBoxEl.classList.add("show");
            if (lastPlayers === 1) {
                lastWinnerEl.textContent = "Solo player (refunded)";
                lastPrizeEl.textContent = "";
            } else if (winners.length === 0 || lastHS === 0) {
                lastWinnerEl.textContent = "No scores (all refunded)";
                lastPrizeEl.textContent = "";
            } else if (winners.length === 1) {
                lastWinnerEl.textContent = shortAddress(winners[0]);
                lastPrizeEl.textContent = lastPrize.toFixed(1) + " MON (Score: " + lastHS + ")";
            } else {
                lastWinnerEl.textContent = winners.length + "-way tie!";
                lastPrizeEl.textContent = lastPrize.toFixed(1) + " MON each";
            }
        }
        
        await updateBalance();
        updateStartMessage();
        
    } catch (e) {
        console.error("Tournament info error:", e);
    }
}

function updateStartMessage() {
    const bal = parseFloat(balanceEl.textContent) || 0;
    
    if (gameMode === "practice") {
        if (bal < 0.001) {
            startMsgEl.textContent = "DEPOSIT MON TO PLAY";
        } else {
            startMsgEl.textContent = "TAP OR PRESS SPACE TO START";
        }
        startMsgEl.style.color = "#feca57";
    } else {
        // Tournament mode
        if (bal < 0.001) {
            startMsgEl.textContent = "DEPOSIT MON TO JOIN";
            startMsgEl.style.color = "#feca57";
        } else if (currentPhase === 0 && !isRegistered) {
            startMsgEl.textContent = "JOIN TOURNAMENT TO PLAY";
            startMsgEl.style.color = "#feca57";
        } else if (currentPhase === 0 && isRegistered) {
            startMsgEl.textContent = "‚úì REGISTERED! WAIT FOR PLAY PHASE";
            startMsgEl.style.color = "#8BC34A";
        } else if (currentPhase === 1 && isRegistered) {
            startMsgEl.textContent = "TAP OR PRESS SPACE TO PLAY!";
            startMsgEl.style.color = "#feca57";
        } else if (currentPhase === 1 && !isRegistered) {
            startMsgEl.textContent = "NOT REGISTERED - WAIT FOR NEXT";
            startMsgEl.style.color = "#f44336";
        }
    }
}

// ===================
// CONNECT WALLET
// ===================
connectBtnEl.onclick = async function() {
    if (!window.ethereum) {
        alert("Please install MetaMask!");
        return;
    }
    
    connectBtnEl.disabled = true;
    connectBtnEl.textContent = "Connecting...";
    
    try {
        // Request accounts
        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        
        // Check/switch network
        const network = await provider.getNetwork();
        if (network.chainId !== 10143) {
            try {
                await window.ethereum.request({
                    method: "wallet_switchEthereumChain",
                    params: [{ chainId: CHAIN_ID }]
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: "wallet_addEthereumChain",
                        params: [{
                            chainId: CHAIN_ID,
                            chainName: "Monad Testnet",
                            nativeCurrency: { name: "MON", symbol: "MON", decimals: 18 },
                            rpcUrls: [RPC_URL],
                            blockExplorerUrls: [EXPLORER]
                        }]
                    });
                }
            }
            provider = new ethers.providers.Web3Provider(window.ethereum);
        }
        
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        
        // Setup burner wallet
        burnerWallet = getBurnerWallet();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, burnerWallet);
        
        // Update UI
        connectBtnEl.textContent = shortAddress(userAddress);
        connectBtnEl.classList.add("connected");
        walletInfoEl.classList.add("show");
        addressEl.textContent = burnerWallet.address;
        
        // Copy address on click
        addressEl.onclick = () => {
            navigator.clipboard.writeText(burnerWallet.address);
            addressEl.textContent = "Copied!";
            setTimeout(() => addressEl.textContent = burnerWallet.address, 1000);
        };
        
        // Start polling
        await updateTournamentInfo();
        setInterval(updateTournamentInfo, 3000);
        setInterval(updateGameTimer, 100);
        
    } catch (e) {
        console.error("Connect error:", e);
        connectBtnEl.textContent = "Connect Wallet";
    }
    
    connectBtnEl.disabled = false;
};

// ===================
// DEPOSIT / SEND
// ===================
async function deposit(amount) {
    if (!signer || !amount || amount <= 0) return;
    
    try {
        connectBtnEl.textContent = "Depositing...";
        const tx = await signer.sendTransaction({
            to: burnerWallet.address,
            value: ethers.utils.parseEther(amount.toString())
        });
        await tx.wait();
        await updateBalance();
        connectBtnEl.textContent = shortAddress(userAddress);
    } catch (e) {
        console.error("Deposit error:", e);
        connectBtnEl.textContent = shortAddress(userAddress);
    }
}

$("depositBtn").onclick = () => deposit(parseFloat($("depositAmount").value));

document.querySelectorAll(".quick-amounts button").forEach(btn => {
    btn.onclick = () => deposit(parseFloat(btn.dataset.amount));
});

$("sendBtn").onclick = async function() {
    const toAddr = $("sendAddress").value.trim();
    const amount = parseFloat($("sendAmount").value);
    if (!toAddr || !amount) return;
    
    try {
        const tx = await burnerWallet.sendTransaction({
            to: toAddr,
            value: ethers.utils.parseEther(amount.toString()),
            gasLimit: 21000
        });
        await tx.wait();
        await updateBalance();
    } catch (e) {
        console.error("Send error:", e);
    }
};

// ===================
// JOIN TOURNAMENT
// ===================
joinBtnEl.onclick = async function() {
    if (!contract || isRegistered || currentPhase !== 0) return;
    
    joinBtnEl.disabled = true;
    joinBtnEl.textContent = "Joining...";
    
    try {
        const tx = await contract.joinTournament({
            value: ethers.utils.parseEther("10"),
            gasLimit: 200000
        });
        await tx.wait();
        isRegistered = true;
        joinBtnEl.textContent = "‚úì Joined!";
        joinBtnEl.classList.add("joined");
        await updateTournamentInfo();
    } catch (e) {
        console.error("Join error:", e);
        joinBtnEl.textContent = "Join Tournament (10 MON)";
        joinBtnEl.disabled = false;
    }
};

// ===================
// MODE TOGGLE
// ===================
$("practiceBtn").onclick = function() {
    gameMode = "practice";
    this.classList.add("active");
    $("tournamentBtn").classList.remove("active");
    gameEl.classList.remove("tournament-mode");
    badgeEl.classList.remove("show");
    gameTimerEl.classList.remove("show");
    updateStartMessage();
};

$("tournamentBtn").onclick = function() {
    gameMode = "tournament";
    this.classList.add("active");
    $("practiceBtn").classList.remove("active");
    updateStartMessage();
};

// ===================
// GAME TIMER (for tournament mode during play)
// ===================
function updateGameTimer() {
    if (!gameRunning || gameMode !== "tournament" || playPhaseEndTime === 0) return;
    
    const remaining = Math.max(0, playPhaseEndTime - Date.now());
    const secs = Math.floor(remaining / 1000);
    const mins = Math.floor(secs / 60);
    const s = secs % 60;
    
    gameTimerEl.textContent = mins + ":" + (s < 10 ? "0" : "") + s;
    gameTimerEl.classList.toggle("urgent", secs <= 10);
    
    // Time's up!
    if (remaining <= 0) {
        endGame("TIME'S UP!");
    }
}

// ===================
// BRANCHES
// ===================
function createBranch(side, bottom) {
    const el = document.createElement("div");
    el.className = "branch " + side;
    el.style.bottom = bottom + "px";
    el.innerHTML = '<div class="branch-wood"></div><div class="branch-leaves"></div>';
    gameEl.appendChild(el);
    return { side, bottom, el };
}

function initBranches() {
    // Remove old branches
    document.querySelectorAll(".branch").forEach(b => b.remove());
    branches = [];
    
    // Create 8 branches
    for (let i = 0; i < 8; i++) {
        const side = Math.random() > 0.5 ? "left" : "right";
        const bottom = 150 + (i * 60);
        branches.push(createBranch(side, bottom));
    }
}

// ===================
// GAME LOGIC
// ===================
function startGame() {
    if (!burnerWallet) return;
    if (gameRunning) return;
    
    const bal = parseFloat(balanceEl.textContent) || 0;
    if (bal < 0.001) return;
    
    // Tournament mode checks
    const isTournament = gameMode === "tournament" && currentPhase === 1 && isRegistered;
    if (gameMode === "tournament" && !isTournament) return;
    
    // Reset state
    score = 0;
    timeLeft = 100;
    gameRunning = true;
    canRestart = false;
    
    // Update UI
    startScreenEl.classList.add("hidden");
    gameOverEl.classList.remove("show");
    scoreEl.textContent = "0";
    timefillEl.style.width = "100%";
    timefillEl.className = "";
    playerEl.className = "left";
    
    if (isTournament) {
        gameEl.classList.add("tournament-mode");
        badgeEl.classList.add("show");
        gameTimerEl.classList.add("show");
    } else {
        gameEl.classList.remove("tournament-mode");
        badgeEl.classList.remove("show");
        gameTimerEl.classList.remove("show");
    }
    
    initBranches();
    requestAnimationFrame(gameLoop);
}

function gameLoop() {
    if (!gameRunning) return;
    
    // Decay timer
    let decay = 0.08;
    if (score >= 20) decay = 0.10;
    if (score >= 40) decay = 0.14;
    if (score >= 70) decay = 0.20;
    if (score >= 100) decay = 0.28;
    
    timeLeft -= decay;
    
    const pct = Math.max(0, timeLeft);
    timefillEl.style.width = pct + "%";
    
    if (pct > 50) timefillEl.className = "";
    else if (pct > 25) timefillEl.className = "warning";
    else timefillEl.className = "danger";
    
    if (timeLeft <= 0) {
        endGame();
        return;
    }
    
    requestAnimationFrame(gameLoop);
}

function chop(side) {
    if (!gameRunning) return;
    
    // Move player
    playerEl.className = side;
    
    // Check if hit branch
    if (branches[0] && branches[0].side === side) {
        endGame();
        return;
    }
    
    // Remove bottom branch
    branches[0].el.remove();
    branches.shift();
    
    // Move branches down
    branches.forEach(b => {
        b.bottom -= 60;
        b.el.style.bottom = b.bottom + "px";
    });
    
    // Add new branch at top
    const newSide = Math.random() > 0.5 ? "left" : "right";
    const newBottom = branches[branches.length - 1].bottom + 60;
    branches.push(createBranch(newSide, newBottom));
    
    // Update score
    score++;
    scoreEl.textContent = score;
    
    // Add time
    timeLeft = Math.min(100, timeLeft + 5);
}

function endGame(reason) {
    if (!gameRunning) return;
    gameRunning = false;
    
    // Check high score
    const isRecord = score > highScore;
    if (isRecord) {
        highScore = score;
        localStorage.setItem("lumberjackHighScore", highScore);
    }
    
    // Update game over screen
    finalScoreEl.textContent = score;
    gameOverMsgEl.textContent = reason || (isRecord ? "üéâ NEW RECORD!" : "Best: " + highScore);
    gameOverEl.classList.toggle("record", isRecord && !reason);
    
    // Submit score if tournament
    const isTournament = gameEl.classList.contains("tournament-mode");
    if (isTournament && isRegistered && score > 0) {
        submitMsgEl.textContent = "Submitting score...";
        submitMsgEl.style.display = "block";
        
        contract.submitScore(score, { gasLimit: 200000 })
            .then(tx => tx.wait())
            .then(() => {
                submitMsgEl.textContent = "‚úÖ Score submitted!";
                if (score > myTournamentScore) {
                    myTournamentScore = score;
                    myScoreEl.textContent = score;
                }
            })
            .catch(e => {
                console.error("Submit error:", e);
                submitMsgEl.textContent = "‚ö†Ô∏è Submit failed";
            });
    } else {
        submitMsgEl.style.display = "none";
    }
    
    // Show game over
    gameOverEl.classList.add("show");
    
    // Allow restart after delay
    setTimeout(() => {
        canRestart = true;
    }, 500);
    
    updateBalance();
}

// ===================
// INPUT HANDLERS
// ===================
function handleInput(side) {
    if (gameRunning) {
        chop(side);
    } else if (canRestart) {
        if (gameOverEl.classList.contains("show")) {
            gameOverEl.classList.remove("show");
            startScreenEl.classList.remove("hidden");
            updateStartMessage();
        } else {
            startGame();
        }
    }
}

// Tap zones
document.querySelector(".tap-zone.left").onclick = () => handleInput("left");
document.querySelector(".tap-zone.right").onclick = () => handleInput("right");
document.querySelector(".tap-zone.left").ontouchstart = e => { e.preventDefault(); handleInput("left"); };
document.querySelector(".tap-zone.right").ontouchstart = e => { e.preventDefault(); handleInput("right"); };

// Play again button
$("playAgainBtn").onclick = () => {
    gameOverEl.classList.remove("show");
    startScreenEl.classList.remove("hidden");
    updateStartMessage();
};

// Keyboard
document.onkeydown = function(e) {
    if (e.key === " " || e.key === "ArrowLeft" || e.key === "ArrowRight") {
        e.preventDefault();
    }
    
    if (e.key === "ArrowLeft") handleInput("left");
    else if (e.key === "ArrowRight") handleInput("right");
    else if (e.key === " ") handleInput("left"); // Space starts or chops left
};

</script>
</body>
</html>
