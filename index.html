<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Monad Lumberjack</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Arial Black', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            user-select: none;
        }
        #header { text-align: center; margin-bottom: 10px; }
        h1 {
            font-size: 32px;
            margin: 10px 0 5px 0;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #highScoreDisplay { font-size: 16px; color: #feca57; }
        #mainContainer { display: flex; gap: 20px; align-items: flex-start; }
        
        #gameArea {
            background: linear-gradient(to bottom, #87CEEB 0%, #B0E0E6 100%);
            width: 380px;
            height: 640px;
            position: relative;
            border: 3px solid #5D4037;
            border-radius: 15px;
            overflow: hidden;
        }
        #gameArea.shake {
            animation: shake 0.3s ease-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .cloud {
            position: absolute;
            background: rgba(255,255,255,0.85);
            border-radius: 50px;
            z-index: 1;
        }
        .cloud::before, .cloud::after {
            content: '';
            position: absolute;
            background: rgba(255,255,255,0.85);
            border-radius: 50%;
        }
        .cloud1 { width: 70px; height: 25px; top: 40px; left: 15px; }
        .cloud1::before { width: 35px; height: 35px; top: -18px; left: 12px; }
        .cloud1::after { width: 45px; height: 40px; top: -20px; left: 35px; }
        .cloud2 { width: 60px; height: 22px; top: 80px; right: 20px; }
        .cloud2::before { width: 30px; height: 30px; top: -15px; left: 10px; }
        .cloud2::after { width: 38px; height: 34px; top: -16px; left: 30px; }
        
        #trunk {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 80px;
            width: 52px;
            height: 500px;
            background: linear-gradient(to right, #4E342E 0%, #6D4C41 15%, #8D6E63 35%, #A1887F 50%, #8D6E63 65%, #6D4C41 85%, #4E342E 100%);
            z-index: 10;
        }
        
        #treeTop {
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 11;
        }
        .treetop-part {
            position: absolute;
            border-radius: 50%;
        }
        .tt1 { width: 90px; height: 65px; background: radial-gradient(ellipse at 50% 60%, #66BB6A, #43A047, #2E7D32); left: -45px; top: 0; }
        .tt2 { width: 65px; height: 50px; background: radial-gradient(ellipse at 50% 60%, #72C472, #4CAF50, #388E3C); left: -58px; top: 28px; }
        .tt3 { width: 65px; height: 50px; background: radial-gradient(ellipse at 50% 60%, #72C472, #4CAF50, #388E3C); left: -7px; top: 28px; }
        
        /* Branches - simple and clean */
        .branch {
            position: absolute;
            left: 50%;
            height: 50px;
            z-index: 9;
            transition: bottom 0.12s ease-out;
        }
        .branch.left { transform: translateX(-26px) translateX(-100%); }
        .branch.right { transform: translateX(26px); }
        
        .branch-inner {
            position: relative;
            width: 95px;
            height: 50px;
        }
        
        .branch-wood {
            position: absolute;
            bottom: 18px;
            width: 50px;
            height: 14px;
            background: linear-gradient(to bottom, #A1887F 0%, #8D6E63 50%, #6D4C41 100%);
        }
        .branch.left .branch-wood { right: 0; border-radius: 8px 0 0 8px; }
        .branch.right .branch-wood { left: 0; border-radius: 0 8px 8px 0; }
        
        .branch-leaf {
            position: absolute;
            bottom: 5px;
            width: 52px;
            height: 44px;
            background: radial-gradient(ellipse at 50% 60%, #7ED67E 0%, #5CB85C 30%, #4CAF50 55%, #388E3C 80%, #2E7D32 100%);
            border-radius: 50%;
        }
        .branch.left .branch-leaf { left: 0; }
        .branch.right .branch-leaf { right: 0; }
        
        #ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 80px;
            background: linear-gradient(to bottom, #7CB342 0%, #558B2F 40%, #33691E 100%);
            z-index: 15;
        }
        #groundHighlight {
            position: absolute;
            bottom: 80px;
            width: 100%;
            height: 10px;
            background: #8BC34A;
            border-radius: 50% 50% 0 0 / 100% 100% 0 0;
            z-index: 15;
        }
        
        #lumberjack {
            position: absolute;
            bottom: 90px;
            width: 60px;
            height: 75px;
            z-index: 20;
            transition: left 0.04s ease-out;
        }
        #lumberjack.left { left: 70px; }
        #lumberjack.right { left: 250px; }
        
        #keoneImg {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 3px solid #5D4037;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #FFCCBC;
            object-fit: cover;
            z-index: 2;
        }
        .lj-body {
            position: absolute;
            top: 31px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 32px;
            background: #E53935;
            border-radius: 4px;
        }
        .lj-body::before {
            content: '';
            position: absolute;
            inset: 3px;
            background: repeating-linear-gradient(90deg, #C62828 0px, #C62828 3px, #1A1A1A 3px, #1A1A1A 6px);
            border-radius: 2px;
        }
        .lj-pants {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 26px;
            height: 16px;
            background: #1565C0;
            border-radius: 0 0 4px 4px;
        }
        #axe {
            position: absolute;
            top: 20px;
            font-size: 26px;
            z-index: 3;
        }
        #lumberjack.left #axe { right: -5px; transform: scaleX(-1); }
        #lumberjack.right #axe { left: -5px; transform: scaleX(1); }
        #axe.swing { animation: swing 0.08s ease-out; }
        @keyframes swing {
            0%, 100% { rotate: 0deg; }
            50% { rotate: -40deg; }
        }
        
        /* Wood chip particles */
        .wood-chip {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #8D6E63;
            border-radius: 2px;
            z-index: 50;
            pointer-events: none;
        }
        .wood-chip.light { background: #A1887F; }
        .wood-chip.dark { background: #5D4037; }
        
        /* Bottom HUD */
        #bottomHUD {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            z-index: 100;
        }
        #scoreDisplay {
            font-size: 36px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 0 #5D4037, 0 0 10px rgba(0,0,0,0.5);
        }
        #timeBarContainer {
            width: 160px;
            height: 12px;
            background: rgba(0,0,0,0.4);
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid #5D4037;
        }
        #timeBarFill {
            height: 100%;
            width: 100%;
            background: linear-gradient(to right, #4CAF50, #8BC34A);
            transition: width 0.1s linear;
        }
        #timeBarFill.warning { background: linear-gradient(to right, #FF9800, #FFC107); }
        #timeBarFill.danger { 
            background: linear-gradient(to right, #f44336, #FF5722);
            animation: pulse-danger 0.3s ease-in-out infinite;
        }
        @keyframes pulse-danger {
            0%, 100% { box-shadow: 0 0 5px #f44336; }
            50% { box-shadow: 0 0 15px #f44336, 0 0 25px #ff0000; }
        }
        
        .tap-zone { position: absolute; top: 0; width: 50%; height: 100%; z-index: 30; cursor: pointer; }
        .tap-zone.left { left: 0; }
        .tap-zone.right { right: 0; }
        
        /* Side Panel */
        #sidePanel { display: flex; flex-direction: column; gap: 12px; width: 250px; }
        .panel-section { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
        button { padding: 10px 16px; font-size: 14px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; width: 100%; color: white; }
        #wallet { background: linear-gradient(135deg, #667eea, #764ba2); }
        #wallet.connected { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .fund-btn { background: linear-gradient(135deg, #f093fb, #f5576c); padding: 8px; font-size: 11px; flex: 1; }
        #startBtn { background: linear-gradient(135deg, #f5576c, #f093fb); font-size: 16px; padding: 12px; }
        #startBtn:disabled { opacity: 0.5; cursor: not-allowed; }
        #status { font-size: 11px; text-align: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; }
        #fundOptions { display: none; margin-top: 8px; }
        #burnerInfo { font-size: 10px; text-align: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; margin-top: 8px; display: none; word-break: break-all; cursor: pointer; }
        #withdrawSection { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); }
        .instructions { font-size: 11px; line-height: 1.4; opacity: 0.8; }
        .instructions p { margin: 3px 0; }
        .highlight { color: #feca57; }
        
        /* Leaderboard */
        #leaderboard h3 { font-size: 14px; margin-bottom: 8px; color: #feca57; }
        #leaderboardList { font-size: 11px; }
        .lb-entry { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .lb-entry:last-child { border-bottom: none; }
        .lb-rank { color: #feca57; width: 20px; }
        .lb-addr { opacity: 0.8; }
        .lb-score { color: #8BC34A; font-weight: bold; }
        
        /* Overlays */
        #startOverlay {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.75);
            z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        #startOverlay.hidden { display: none; }
        #startOverlay h2 { font-size: 24px; margin-bottom: 12px; }
        #startOverlay p { font-size: 14px; opacity: 0.85; margin: 5px 0; }
        #tapToStart { margin-top: 20px; font-size: 16px; color: #feca57; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        
        #gameOver {
            display: none; position: absolute; inset: 0;
            background: rgba(0,0,0,0.9); z-index: 100;
            flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;
            opacity: 0;
            pointer-events: none;
        }
        #gameOver.show {
            display: flex;
            animation: fadeInOverlay 0.8s ease-out forwards;
        }
        #gameOver.show.canRestart {
            pointer-events: auto;
        }
        @keyframes fadeInOverlay {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        #gameOver h2 { font-size: 24px; color: #f5576c; margin-bottom: 5px; }
        #gameOver.newRecord h2 { color: #feca57; }
        #finalScore { font-size: 56px; font-weight: bold; color: white; margin: 8px 0; }
        #txSummary { font-size: 15px; color: #9c27b0; margin: 8px 0; padding: 8px 16px; background: rgba(156,39,176,0.2); border-radius: 12px; }
        #beatScore { font-size: 12px; color: #feca57; margin: 6px 0; }
        #restartBtn { background: linear-gradient(135deg, #f5576c, #f093fb); margin-top: 15px; font-size: 15px; padding: 12px 30px; width: auto; }
        #txLink { margin-top: 10px; }
        #txLink a { color: #54a0ff; text-decoration: none; font-size: 12px; }
        
        @media (max-width: 700px) {
            #mainContainer { flex-direction: column; align-items: center; }
            #sidePanel { width: 380px; max-width: 100%; }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>ü™ì MONAD LUMBERJACK</h1>
        <div id="highScoreDisplay">üèÜ Best: <span id="highScoreTop">0</span></div>
    </div>
    
    <div id="mainContainer">
        <div id="gameArea">
            <div class="cloud cloud1"></div>
            <div class="cloud cloud2"></div>
            
            <div id="treeTop">
                <div class="treetop-part tt1"></div>
                <div class="treetop-part tt2"></div>
                <div class="treetop-part tt3"></div>
            </div>
            <div id="trunk"></div>
            
            <div id="lumberjack" class="left">
                <img src="keone.png" alt="" id="keoneImg" onerror="this.style.background='#FFCCBC'">
                <div class="lj-body"></div>
                <div class="lj-pants"></div>
                <div id="axe">ü™ì</div>
            </div>
            
            <div id="groundHighlight"></div>
            <div id="ground"></div>
            
            <div id="bottomHUD">
                <div id="scoreDisplay">0</div>
                <div id="timeBarContainer"><div id="timeBarFill"></div></div>
            </div>
            
            <div class="tap-zone left" id="tapLeft"></div>
            <div class="tap-zone right" id="tapRight"></div>
            
            <div id="startOverlay">
                <h2>ü™ì TAP TO CHOP</h2>
                <p>‚¨ÖÔ∏è Tap left = chop left</p>
                <p>‚û°Ô∏è Tap right = chop right</p>
                <p>üåø Avoid the branches!</p>
                <div id="tapToStart">CONNECT WALLET TO PLAY</div>
            </div>
            
            <div id="gameOver">
                <h2>GAME OVER</h2>
                <div id="finalScore">0</div>
                <div id="txSummary">‚ö° 0 transactions</div>
                <div id="beatScore"></div>
                <div id="txLink"></div>
                <button id="restartBtn">PLAY AGAIN</button>
            </div>
        </div>
        
        <div id="sidePanel">
            <div class="panel-section">
                <button id="wallet">Connect Wallet</button>
                <div id="fundOptions">
                    <div style="display:flex; gap:6px; margin-bottom:6px;">
                        <button class="fund-btn" data-amount="1">1 MON</button>
                        <button class="fund-btn" data-amount="10">10 MON</button>
                        <button class="fund-btn" data-amount="100">100 MON</button>
                    </div>
                    <div style="display:flex; gap:6px;">
                        <input type="number" id="customAmount" placeholder="Custom" style="flex:1; padding:8px; border-radius:6px; border:none; font-size:12px;">
                        <button class="fund-btn" id="customFundBtn">Fund</button>
                    </div>
                </div>
                <div id="status">Connect wallet to play</div>
                <div id="burnerInfo"></div>
                <div id="withdrawSection">
                    <div style="font-size:10px; margin-bottom:4px; opacity:0.7;">Withdraw MON:</div>
                    <input type="text" id="withdrawAddress" placeholder="0x..." style="width:100%; padding:6px; border-radius:5px; border:none; font-size:10px; margin-bottom:4px;">
                    <div style="display:flex; gap:4px;">
                        <input type="number" id="withdrawAmount" placeholder="Amt" style="flex:1; padding:6px; border-radius:5px; border:none; font-size:10px;">
                        <button id="withdrawBtn" style="padding:6px 10px; font-size:10px; background:linear-gradient(135deg,#e74c3c,#c0392b); border:none; border-radius:5px; cursor:pointer; color:white;">Send</button>
                    </div>
                </div>
            </div>
            <div class="panel-section">
                <button id="startBtn" disabled>START GAME</button>
                <div style="font-size:10px; text-align:center; opacity:0.5; margin-top:5px;">or press SPACE</div>
            </div>
            <div class="panel-section" id="leaderboard">
                <h3>üåç Global Leaderboard</h3>
                <div id="leaderboardList">Loading...</div>
            </div>
            <div class="panel-section instructions">
                <p><strong>How to Play:</strong></p>
                <p>‚Ä¢ Tap <span class="highlight">left</span> or <span class="highlight">right</span></p>
                <p>‚Ä¢ Don't get hit by branches!</p>
                <p>‚Ä¢ Each chop = 1 tx ‚ö°</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        const CONTRACT="0x571044cf1Fd3a1cac6c2b06e4b6A08528dFF63F0";
        const ABI=["function startGame(address) external","function chop(address,uint256) external","function endGame(address,uint256) external","function getHighScore(address) view returns (uint256)","event GameEnded(address indexed player, uint256 score)"];
        const CHAIN_ID='0x279f', RPC='https://testnet-rpc.monad.xyz', EXPLORER='https://testnet.monadexplorer.com';
        
        let score=0, highScore=0, gameActive=false, playerSide='left';
        let branches=[], timeLeft=100, txCount=0, nonce=null, canRestart=false;
        let provider, signer, userAddress, burner, contract, animFrame;
        let deathSound;
        
        const $=id=>document.getElementById(id);
        const gameArea=$('gameArea'), scoreDisplay=$('scoreDisplay'), timeBar=$('timeBarFill');
        const lumberjack=$('lumberjack'), axe=$('axe');
        const startOverlay=$('startOverlay'), gameOver=$('gameOver');
        const startBtn=$('startBtn'), walletBtn=$('wallet');
        const statusDiv=$('status'), burnerInfo=$('burnerInfo');
        const fundOptions=$('fundOptions'), tapToStart=$('tapToStart');
        const highScoreEl=$('highScoreTop'), withdrawSection=$('withdrawSection');
        
        // Initialize death sound
        async function initAudio(){
            await Tone.start();
            deathSound = new Tone.Synth({
                oscillator: { type: 'square' },
                envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.1 }
            }).toDestination();
            deathSound.volume.value = -10;
        }
        
        function playDeathSound(){
            if(deathSound){
                deathSound.triggerAttackRelease('C3', '8n');
                setTimeout(()=>deathSound.triggerAttackRelease('G2', '8n'), 100);
                setTimeout(()=>deathSound.triggerAttackRelease('C2', '4n'), 200);
            }
        }
        
        // Wood chip particles
        function spawnWoodChips(x, y){
            for(let i=0; i<6; i++){
                const chip = document.createElement('div');
                chip.className = 'wood-chip ' + ['','light','dark'][Math.floor(Math.random()*3)];
                chip.style.left = x + 'px';
                chip.style.top = y + 'px';
                chip.style.width = (4 + Math.random()*6) + 'px';
                chip.style.height = (4 + Math.random()*6) + 'px';
                gameArea.appendChild(chip);
                
                const angle = (Math.random() - 0.5) * Math.PI;
                const speed = 3 + Math.random() * 5;
                const vx = Math.cos(angle) * speed * (playerSide === 'left' ? -1 : 1);
                const vy = -Math.random() * 6 - 2;
                let cx = x, cy = y, gravity = 0.3, opacity = 1;
                
                function animateChip(){
                    cx += vx;
                    cy += vy;
                    vy += gravity;
                    opacity -= 0.02;
                    chip.style.left = cx + 'px';
                    chip.style.top = cy + 'px';
                    chip.style.opacity = opacity;
                    chip.style.transform = `rotate(${cx * 5}deg)`;
                    if(opacity > 0) requestAnimationFrame(animateChip);
                    else chip.remove();
                }
                requestAnimationFrame(animateChip);
            }
        }
        
        highScore = parseInt(localStorage.getItem('lumberjackHS')||'0');
        highScoreEl.textContent = highScore;
        
        function getBurner(){
            let pk=localStorage.getItem('lumberjackPK');
            if(!pk){pk=ethers.Wallet.createRandom().privateKey;localStorage.setItem('lumberjackPK',pk);}
            return new ethers.Wallet(pk,new ethers.providers.JsonRpcProvider(RPC));
        }
        async function getBalance(){
            if(!burner)return 0;
            return parseFloat(ethers.utils.formatEther(await burner.getBalance()));
        }
        
        // Fetch leaderboard from contract events
        async function fetchLeaderboard(){
            try {
                const rpcProvider = new ethers.providers.JsonRpcProvider(RPC);
                
                // Get recent blocks only to avoid timeout
                const currentBlock = await rpcProvider.getBlockNumber();
                const fromBlock = Math.max(0, currentBlock - 100000);
                
                const logs = await rpcProvider.getLogs({
                    address: CONTRACT,
                    fromBlock: fromBlock,
                    toBlock: 'latest'
                });
                
                const scores = {};
                logs.forEach(log => {
                    try {
                        // Check if this looks like a GameEnded event (has score data)
                        if(log.data && log.data.length >= 66 && log.topics && log.topics.length >= 2) {
                            const player = '0x' + log.topics[1].slice(26).toLowerCase();
                            const score = parseInt(log.data.slice(0, 66), 16);
                            
                            if(score > 0 && score < 10000) {
                                if(!scores[player] || scores[player] < score) {
                                    scores[player] = score;
                                }
                            }
                        }
                    } catch(e) {}
                });
                
                const sorted = Object.entries(scores)
                    .sort((a,b) => b[1] - a[1])
                    .slice(0, 10);
                
                if(sorted.length === 0){
                    $('leaderboardList').innerHTML = '<div style="opacity:0.5; font-size:10px;">No scores yet!</div>';
                    return;
                }
                
                $('leaderboardList').innerHTML = sorted.map((entry, i) => `
                    <div class="lb-entry">
                        <span class="lb-rank">${i+1}.</span>
                        <span class="lb-addr">${entry[0].slice(0,6)}...${entry[0].slice(-4)}</span>
                        <span class="lb-score">${entry[1]}</span>
                    </div>
                `).join('');
                
            } catch(e) {
                console.error('Leaderboard error:', e);
                $('leaderboardList').innerHTML = '<div style="opacity:0.5; font-size:10px;">Loading...</div>';
            }
        }
        fetchLeaderboard();
        
        walletBtn.onclick=async()=>{
            if(!window.ethereum){alert('Install MetaMask!');return;}
            try{
                statusDiv.textContent='Connecting...';
                await window.ethereum.request({method:'eth_requestAccounts'});
                provider=new ethers.providers.Web3Provider(window.ethereum);
                const net=await provider.getNetwork();
                if(net.chainId!==10143){
                    try{await window.ethereum.request({method:'wallet_switchEthereumChain',params:[{chainId:CHAIN_ID}]});}
                    catch(e){if(e.code===4902)await window.ethereum.request({method:'wallet_addEthereumChain',params:[{chainId:CHAIN_ID,chainName:'Monad Testnet',nativeCurrency:{name:'MON',symbol:'MON',decimals:18},rpcUrls:[RPC]}]});}
                    provider=new ethers.providers.Web3Provider(window.ethereum);
                }
                signer=provider.getSigner();
                userAddress=await signer.getAddress();
                burner=getBurner();
                contract=new ethers.Contract(CONTRACT,ABI,burner);
                walletBtn.textContent=userAddress.slice(0,6)+'...'+userAddress.slice(-4);
                walletBtn.classList.add('connected');
                const bal=await getBalance();
                burnerInfo.style.display='block';
                burnerInfo.innerHTML=`üéÆ Game Wallet:<br><b>${burner.address}</b><br>Balance: ${bal.toFixed(4)} MON`;
                burnerInfo.onclick=()=>{navigator.clipboard.writeText(burner.address);statusDiv.textContent='Copied!';};
                fundOptions.style.display='block';
                withdrawSection.style.display='block';
                if(bal<0.01){statusDiv.textContent='Fund wallet to play';startBtn.disabled=true;tapToStart.textContent='FUND WALLET TO PLAY';}
                else{statusDiv.textContent=`Ready! ${bal.toFixed(3)} MON`;startBtn.disabled=false;tapToStart.textContent='TAP TO START';}
                initAudio();
            }catch(e){console.error(e);statusDiv.textContent='Failed';}
        };
        
        async function fund(amt){
            try{
                statusDiv.textContent='Confirm...';
                const tx=await signer.sendTransaction({to:burner.address,value:ethers.utils.parseEther(amt.toString())});
                statusDiv.textContent='Funding...';
                await tx.wait();
                const bal=await getBalance();
                statusDiv.textContent=`Ready! ${bal.toFixed(3)} MON`;
                burnerInfo.innerHTML=`üéÆ Game Wallet:<br><b>${burner.address}</b><br>Balance: ${bal.toFixed(4)} MON`;
                startBtn.disabled=false;tapToStart.textContent='TAP TO START';
            }catch(e){statusDiv.textContent='Failed';}
        }
        document.querySelectorAll('.fund-btn[data-amount]').forEach(b=>b.onclick=()=>fund(b.dataset.amount));
        $('customFundBtn').onclick=()=>{const a=parseFloat($('customAmount').value);if(a>0)fund(a);};
        $('withdrawBtn').onclick=async()=>{
            const addr=$('withdrawAddress').value.trim(),amt=parseFloat($('withdrawAmount').value);
            if(!addr||!amt)return;
            try{statusDiv.textContent='Sending...';await(await burner.sendTransaction({to:addr,value:ethers.utils.parseEther(amt.toString()),gasLimit:21000})).wait();
            const bal=await getBalance();burnerInfo.innerHTML=`üéÆ Game Wallet:<br><b>${burner.address}</b><br>Balance: ${bal.toFixed(4)} MON`;statusDiv.textContent=`Done! ${bal.toFixed(3)} MON`;}
            catch(e){statusDiv.textContent='Failed';}
        };
        
        function createBranch(side, y){
            const el=document.createElement('div');
            el.className='branch '+side;
            el.style.bottom=y+'px';
            el.innerHTML=`
                <div class="branch-inner">
                    <div class="branch-wood"></div>
                    <div class="branch-leaf"></div>
                </div>
            `;
            gameArea.appendChild(el);
            return el;
        }
        
        function initBranches(){
            document.querySelectorAll('.branch').forEach(b=>b.remove());
            branches=[];
            for(let i=0;i<6;i++){
                const side=Math.random()>0.5?'left':'right';
                const y=165+i*70;
                branches.push({side,y,el:createBranch(side,y)});
            }
        }
        
        function startGame(){
            if(!burner||startBtn.disabled)return;
            if(!canRestart && gameOver.classList.contains('show')) return;
            
            score=0;txCount=0;timeLeft=100;playerSide='left';gameActive=true;canRestart=false;
            startOverlay.classList.add('hidden');
            gameOver.classList.remove('show','canRestart','newRecord');
            gameOver.style.display='none';
            startBtn.disabled=true;
            scoreDisplay.textContent='0';
            timeBar.style.width='100%';
            timeBar.className='';
            lumberjack.className='left';
            gameArea.classList.remove('shake');
            initBranches();
            burner.getTransactionCount('pending').then(n=>{nonce=n;contract.startGame(userAddress,{gasLimit:100000,nonce}).catch(console.error);nonce++;});
            requestAnimationFrame(gameLoop);
        }
        
        function gameLoop(){
            if(!gameActive)return;
            // Aggressive decay at higher scores
            const decay = 0.1 * (1 + Math.floor(score/15)*0.15 + (score >= 50 ? 0.2 : 0) + (score >= 100 ? 0.3 : 0));
            timeLeft-=decay;
            const pct=Math.max(0,timeLeft);
            timeBar.style.width=pct+'%';
            timeBar.className=pct>50?'':pct>25?'warning':'danger';
            if(timeLeft<=0){endGame();return;}
            animFrame=requestAnimationFrame(gameLoop);
        }
        
        function chop(side){
            if(!gameActive)return;
            
            playerSide=side;
            lumberjack.className=side;
            
            axe.classList.remove('swing');
            void axe.offsetWidth;
            axe.classList.add('swing');
            
            // Spawn wood chips
            const chipX = side === 'left' ? 160 : 210;
            spawnWoodChips(chipX, 400);
            
            // Check collision
            if(branches[0]&&branches[0].side===side){
                endGame();
                return;
            }
            
            // Remove bottom branch
            branches[0].el.remove();
            branches.shift();
            
            // Move remaining branches down with smooth animation
            branches.forEach(b=>{
                b.y-=70;
                b.el.style.bottom=b.y+'px';
            });
            
            // Add new branch at top
            const newSide=Math.random()>0.5?'left':'right';
            const newY=165+5*70;
            branches.push({side:newSide,y:newY,el:createBranch(newSide,newY)});
            
            score++;
            txCount++;
            timeLeft=Math.min(100,timeLeft+5);
            scoreDisplay.textContent=score;
            
            contract.chop(userAddress,score,{gasLimit:100000,nonce}).catch(console.error);
            nonce++;
        }
        
        function endGame(){
            gameActive=false;
            cancelAnimationFrame(animFrame);
            
            // Screen shake and death sound
            gameArea.classList.add('shake');
            playDeathSound();
            
            const isRecord=score>highScore;
            if(isRecord){highScore=score;localStorage.setItem('lumberjackHS',highScore);highScoreEl.textContent=highScore;}
            
            $('finalScore').textContent=score;
            $('txSummary').textContent=`‚ö° ${txCount} transactions`;
            $('beatScore').textContent=isRecord?'üéâ NEW RECORD!':`Best: ${highScore}`;
            
            if(isRecord) gameOver.classList.add('newRecord');
            gameOver.querySelector('h2').textContent=isRecord?'üéâ NEW RECORD!':'GAME OVER';
            
            // Fade in game over
            gameOver.style.display='flex';
            gameOver.classList.add('show');
            
            // Allow restart after delay
            setTimeout(()=>{
                canRestart=true;
                gameOver.classList.add('canRestart');
                startBtn.disabled=false;
            }, 1000);
            
            (async()=>{
                try{const n=await burner.getTransactionCount('pending');const tx=await contract.endGame(userAddress,score,{gasLimit:150000,nonce:n});const r=await tx.wait();$('txLink').innerHTML=`<a href="${EXPLORER}/tx/${r.transactionHash}" target="_blank">View on Explorer ‚Üí</a>`;fetchLeaderboard();}catch(e){}
                const bal=await getBalance();burnerInfo.innerHTML=`üéÆ Game Wallet:<br><b>${burner.address}</b><br>Balance: ${bal.toFixed(4)} MON`;
            })();
        }
        
        $('restartBtn').onclick=startGame;
        startBtn.onclick=startGame;
        $('tapLeft').onclick=()=>{if(!gameActive&&!startBtn.disabled&&canRestart)startGame();else if(!gameActive&&!startBtn.disabled&&!gameOver.classList.contains('show'))startGame();else chop('left');};
        $('tapRight').onclick=()=>{if(!gameActive&&!startBtn.disabled&&canRestart)startGame();else if(!gameActive&&!startBtn.disabled&&!gameOver.classList.contains('show'))startGame();else chop('right');};
        $('tapLeft').ontouchstart=e=>{e.preventDefault();if(!gameActive&&!startBtn.disabled&&canRestart)startGame();else if(!gameActive&&!startBtn.disabled&&!gameOver.classList.contains('show'))startGame();else chop('left');};
        $('tapRight').ontouchstart=e=>{e.preventDefault();if(!gameActive&&!startBtn.disabled&&canRestart)startGame();else if(!gameActive&&!startBtn.disabled&&!gameOver.classList.contains('show'))startGame();else chop('right');};
        document.onkeydown=e=>{
            if(e.key===' '||e.key==='ArrowLeft'||e.key==='ArrowRight')e.preventDefault();
            if(gameOver.classList.contains('show')&&canRestart&&(e.key===' '||e.key==='ArrowLeft'||e.key==='ArrowRight')){startGame();return;}
            if(e.key===' '&&!gameActive&&!startBtn.disabled&&!gameOver.classList.contains('show'))startGame();
            if(e.key==='ArrowLeft'){if(!gameActive&&!startBtn.disabled&&!gameOver.classList.contains('show'))startGame();else chop('left');}
            if(e.key==='ArrowRight'){if(!gameActive&&!startBtn.disabled&&!gameOver.classList.contains('show'))startGame();else chop('right');}
        };
    </script>
</body>
</html>
