<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Monad Lumberjack</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Arial Black',sans-serif;background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff;display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:10px;user-select:none}
h1{font-size:24px;margin:10px 0;background:linear-gradient(135deg,#f093fb,#f5576c);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
button{padding:10px 16px;font-size:13px;font-weight:bold;border:none;border-radius:8px;cursor:pointer;color:#fff;transition:transform .1s}
button:active{transform:scale(.97)}
button:disabled{opacity:.5;cursor:not-allowed}
input{padding:8px;border-radius:6px;border:none;font-size:12px}
#main{display:flex;gap:20px;align-items:flex-start}
#game{background:linear-gradient(to bottom,#87CEEB,#B0E0E6);width:380px;height:600px;position:relative;border:3px solid #5D4037;border-radius:15px;overflow:hidden}
#game.tournament{border-color:#9c27b0;box-shadow:0 0 20px rgba(156,39,176,.5)}
#game.shake{animation:shake .2s}
@keyframes shake{0%,100%{transform:translateX(0)}25%,75%{transform:translateX(-5px)}50%{transform:translateX(5px)}}
.cloud{position:absolute;background:#fff;border-radius:50px;opacity:.9}
.c1{width:70px;height:25px;top:40px;left:20px}.c2{width:60px;height:20px;top:80px;right:30px}
#trunk{position:absolute;left:50%;transform:translateX(-50%);bottom:80px;width:50px;height:520px;background:linear-gradient(90deg,#5D4037,#8D6E63,#5D4037);z-index:10}
.branch{position:absolute;left:50%;height:45px;z-index:9}
.branch.left{transform:translateX(-25px) translateX(-100%)}
.branch.right{transform:translateX(25px)}
.branch-wood{position:absolute;bottom:15px;width:45px;height:12px;background:#6D4C41}
.branch.left .branch-wood{right:0;border-radius:6px 0 0 6px}
.branch.right .branch-wood{left:0;border-radius:0 6px 6px 0}
.branch-leaf{position:absolute;bottom:5px;width:45px;height:38px;background:radial-gradient(ellipse,#4CAF50,#2E7D32);border-radius:50%}
.branch.left .branch-leaf{left:0}.branch.right .branch-leaf{right:0}
#ground{position:absolute;bottom:0;width:100%;height:80px;background:linear-gradient(#7CB342,#33691E);z-index:15}
#player{position:absolute;bottom:85px;width:50px;height:70px;z-index:20;transition:left .07s}
#player.left{left:75px}#player.right{left:255px}
#player::before{content:'ü™ì';position:absolute;top:15px;font-size:24px}
#player.left::before{right:-8px;transform:scaleX(-1)}
#player.right::before{left:-8px}
.head{width:30px;height:30px;background:#FFCCBC;border-radius:50%;border:2px solid #5D4037;margin:0 auto}
.body{width:24px;height:28px;background:#E53935;border-radius:3px;margin:2px auto 0}
.legs{width:20px;height:12px;background:#1565C0;border-radius:0 0 3px 3px;margin:0 auto}
#hud{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);text-align:center;z-index:100}
#score{font-size:36px;text-shadow:2px 2px #5D4037}
#timebar{width:150px;height:10px;background:rgba(0,0,0,.3);border-radius:5px;margin-top:5px;overflow:hidden}
#timefill{height:100%;width:100%;background:linear-gradient(90deg,#4CAF50,#8BC34A);transition:width .1s}
#timefill.warn{background:linear-gradient(90deg,#FF9800,#FFC107)}
#timefill.danger{background:#f44336}
#badge{display:none;position:absolute;top:10px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#9c27b0,#e91e63);padding:5px 12px;border-radius:15px;font-size:11px;z-index:100}
#badge.show{display:block}
#gameTimer{display:none;position:absolute;top:40px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);padding:3px 10px;border-radius:10px;font-size:16px;color:#feca57;z-index:100}
#gameTimer.show{display:block}
#gameTimer.urgent{color:#f44336}
.zone{position:absolute;top:0;width:50%;height:100%;z-index:30;cursor:pointer}
.zone.left{left:0}.zone.right{right:0}
.overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px}
#start{background:rgba(0,0,0,.7);z-index:50}
#start.hidden{display:none}
#start h2{font-size:20px;margin-bottom:10px}
#start p{font-size:12px;opacity:.8;margin:3px 0}
#tapMsg{margin-top:15px;font-size:13px;color:#feca57;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:.5}50%{opacity:1}}
#end{background:rgba(0,0,0,.85);z-index:100;display:none}
#end.show{display:flex}
#end h2{font-size:20px;color:#f5576c}
#end.record h2{color:#feca57}
#finalScore{font-size:42px;font-weight:bold;margin:8px 0}
#endMsg{font-size:12px;color:#feca57;margin:5px 0}
#submitStatus{font-size:11px;color:#8BC34A;margin:8px 0;display:none}
#submitStatus.show{display:block}
#restartBtn{background:linear-gradient(135deg,#f5576c,#f093fb);margin-top:10px}
#side{width:260px;display:flex;flex-direction:column;gap:10px}
.box{background:rgba(255,255,255,.05);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.1)}
#connectBtn{background:linear-gradient(135deg,#667eea,#764ba2);width:100%}
#connectBtn.connected{background:linear-gradient(135deg,#11998e,#38ef7d);font-size:10px}
#wallet{display:none;margin-top:8px;text-align:center}
.bal{font-size:20px;font-weight:bold;color:#8BC34A;margin:5px 0}
.addr{font-size:9px;opacity:.6;cursor:pointer}
.row{display:flex;gap:5px;margin-top:8px}
.row input{flex:1;min-width:0}
.row button{padding:8px 10px;font-size:11px}
.fundBtn{background:#4CAF50}
.sendBtn{background:#ff9800}
.quick{display:flex;gap:4px;margin-top:5px}
.quick button{flex:1;padding:5px;font-size:10px;background:rgba(255,255,255,.1)}
.tbox{background:linear-gradient(135deg,rgba(156,39,176,.2),rgba(233,30,99,.2));border-color:rgba(156,39,176,.4)}
.tbox h3{color:#e91e63;font-size:12px;margin-bottom:8px}
#phase{text-align:center;padding:6px;border-radius:6px;font-size:13px;font-weight:bold;margin-bottom:5px}
#phase.signup{background:rgba(76,175,80,.3);color:#8BC34A}
#phase.play{background:rgba(233,30,99,.3);color:#e91e63}
#timer{font-size:28px;font-weight:bold;text-align:center;color:#feca57}
.stats{display:flex;justify-content:space-around;margin:8px 0;text-align:center}
.stats .v{font-size:16px;font-weight:bold;color:#8BC34A}
.stats .l{font-size:9px;opacity:.7}
#joinBtn{background:linear-gradient(135deg,#9c27b0,#e91e63);width:100%;margin-top:5px}
#joinBtn.joined{background:#4CAF50}
#myScore{margin-top:6px;padding:6px;background:rgba(0,0,0,.3);border-radius:5px;text-align:center;font-size:11px;display:none}
#myScore.show{display:block}
#lastResult{margin-top:8px;padding:8px;background:rgba(76,175,80,.2);border-radius:6px;text-align:center;font-size:11px;display:none}
#lastResult.show{display:block}
#lastResult .winner{color:#8BC34A;font-weight:bold;font-size:12px}
#lastResult .prize{color:#feca57}
.mode{display:flex;gap:5px;margin-bottom:10px}
.mode button{flex:1;padding:8px;font-size:11px;background:rgba(255,255,255,.1);color:rgba(255,255,255,.5)}
.mode button.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
.mode button.tournament.active{background:linear-gradient(135deg,#9c27b0,#e91e63)}
.info{font-size:9px;opacity:.5;text-align:center;line-height:1.4;margin-top:10px}
@media(max-width:700px){#main{flex-direction:column;align-items:center}#side{width:380px}}
</style>
</head>
<body>
<h1>ü™ì MONAD LUMBERJACK</h1>
<div id="main">
<div id="game">
    <div class="cloud c1"></div><div class="cloud c2"></div>
    <div id="trunk"></div>
    <div id="badge">üèÜ TOURNAMENT</div>
    <div id="gameTimer">0:00</div>
    <div id="player" class="left"><div class="head"></div><div class="body"></div><div class="legs"></div></div>
    <div id="ground"></div>
    <div id="hud"><div id="score">0</div><div id="timebar"><div id="timefill"></div></div></div>
    <div class="zone left"></div><div class="zone right"></div>
    <div id="start" class="overlay">
        <h2>ü™ì TAP TO CHOP</h2>
        <p>‚¨ÖÔ∏è Left side = chop left</p>
        <p>‚û°Ô∏è Right side = chop right</p>
        <p>üåø Don't hit branches!</p>
        <div id="tapMsg">CONNECT WALLET TO PLAY</div>
    </div>
    <div id="end" class="overlay">
        <h2>GAME OVER</h2>
        <div id="finalScore">0</div>
        <div id="endMsg"></div>
        <div id="submitStatus"></div>
        <button id="restartBtn">PLAY AGAIN</button>
    </div>
</div>
<div id="side">
    <div class="mode">
        <button class="active" id="practiceBtn">üéÆ PRACTICE</button>
        <button class="tournament" id="tournamentBtn">üèÜ TOURNAMENT</button>
    </div>
    <div class="box">
        <button id="connectBtn">Connect Wallet</button>
        <div id="wallet">
            <div>Game Wallet</div>
            <div class="bal"><span id="balAmt">0</span> MON</div>
            <div class="addr" id="walletAddr">-</div>
            <div class="row">
                <input type="number" id="fundAmt" placeholder="Amount">
                <button class="fundBtn" id="fundBtn">Deposit</button>
            </div>
            <div class="quick">
                <button data-v="1">1</button><button data-v="5">5</button>
                <button data-v="10">10</button><button data-v="25">25</button>
            </div>
            <div class="row" style="margin-top:8px">
                <input type="text" id="sendAddr" placeholder="0x...">
                <input type="number" id="sendAmt" placeholder="Amt" style="width:45px">
                <button class="sendBtn" id="sendBtn">Send</button>
            </div>
        </div>
    </div>
    <div class="box tbox">
        <h3>üèÜ TOURNAMENT #<span id="tNum">1</span></h3>
        <div id="phase" class="signup">üìù SIGNUP</div>
        <div id="timer">1:00</div>
        <div class="stats">
            <div><div class="v" id="tPrize">0</div><div class="l">Prize Pool</div></div>
            <div><div class="v" id="tPlayers">0</div><div class="l">Players</div></div>
            <div><div class="v" id="tHigh">0</div><div class="l">High Score</div></div>
        </div>
        <button id="joinBtn" disabled>Join (10 MON)</button>
        <div id="myScore">Your best: <span id="myScoreVal">0</span></div>
        <div id="lastResult">
            <div id="lastTitle">üéâ Last Winner</div>
            <div class="winner" id="lastWinner">-</div>
            <div class="prize" id="lastPrize"></div>
        </div>
    </div>
    <div class="info">
        üìù Signup (1 min) ‚Üí üéÆ Play (1 min) ‚Üí üèÜ Winner takes all!<br>
        Ties split pot. Solo player refunded.
    </div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
const CONTRACT="0xYOUR_NEW_CONTRACT_ADDRESS";
const ABI=["function joinTournament() payable","function submitScore(uint256)","function advance()","function getTournamentInfo() view returns (uint256,uint8,uint256,uint256,uint256,uint256)","function isRegistered(address) view returns (bool)","function getMyScore() view returns (uint256)","function getLastResult() view returns (address[],uint256,uint256,uint256)","function startGame()","function endGame(uint256)"];
const RPC="https://testnet-rpc.monad.xyz",CHAIN="0x279f",EXPLORER="https://testnet.monadexplorer.com";

const $=id=>document.getElementById(id);
const fmt=a=>a.slice(0,6)+"..."+a.slice(-4);

let provider,signer,userAddr,burner,contract;
let mode="practice",phase=0,playEndTime=0,registered=false,myBestScore=0;
let score=0,highScore=+(localStorage.lumberjackHS||0),timeLeft=100;
let branches=[],gameActive=false,canRestart=true,lastChop=0;

// DOM
const game=$("game"),scoreEl=$("score"),timefill=$("timefill"),player=$("player");
const startEl=$("start"),endEl=$("end"),tapMsg=$("tapMsg"),badge=$("badge"),gameTimer=$("gameTimer");
const connectBtn=$("connectBtn"),joinBtn=$("joinBtn"),phaseEl=$("phase"),timerEl=$("timer");

// Init
$("practiceBtn").onclick=()=>{mode="practice";$("practiceBtn").classList.add("active");$("tournamentBtn").classList.remove("active");updateUI();};
$("tournamentBtn").onclick=()=>{mode="tournament";$("tournamentBtn").classList.add("active");$("practiceBtn").classList.remove("active");updateUI();};

function updateUI(){
    const bal=parseFloat($("balAmt").textContent)||0;
    if(mode==="practice"){
        tapMsg.textContent=bal<0.001?"DEPOSIT MON TO PLAY":"TAP OR SPACE TO START";
        tapMsg.style.color="#feca57";
    }else{
        if(bal<0.001){tapMsg.textContent="DEPOSIT MON TO JOIN";tapMsg.style.color="#feca57";}
        else if(phase===0&&!registered){tapMsg.textContent="JOIN TOURNAMENT TO PLAY";tapMsg.style.color="#feca57";}
        else if(phase===0&&registered){tapMsg.textContent="‚úì REGISTERED - WAITING";tapMsg.style.color="#8BC34A";}
        else if(phase===1&&registered){tapMsg.textContent="TAP OR SPACE TO PLAY!";tapMsg.style.color="#feca57";}
        else if(phase===1&&!registered){tapMsg.textContent="NOT REGISTERED";tapMsg.style.color="#f5576c";}
        else{tapMsg.textContent="LOADING...";tapMsg.style.color="#feca57";}
    }
}

function getBurner(){
    let pk=localStorage.lumberjackPK;
    if(!pk){pk=ethers.Wallet.createRandom().privateKey;localStorage.lumberjackPK=pk;}
    return new ethers.Wallet(pk,new ethers.providers.JsonRpcProvider(RPC));
}

async function updateBal(){
    if(!burner)return;
    const bal=+ethers.utils.formatEther(await burner.getBalance());
    $("balAmt").textContent=bal.toFixed(3);
    joinBtn.disabled=bal<10||registered||phase!==0;
    updateUI();
}

async function updateTournament(){
    if(!contract)return;
    try{
        await contract.advance().catch(()=>{});
        const[id,ph,timeRem,prize,players,high]=await contract.getTournamentInfo();
        $("tNum").textContent=id.toString();
        phase=ph;
        $("tPrize").textContent=(+ethers.utils.formatEther(prize)).toFixed(0);
        $("tPlayers").textContent=players.toString();
        $("tHigh").textContent=high.toString();
        
        const secs=timeRem.toNumber(),m=Math.floor(secs/60),s=secs%60;
        timerEl.textContent=`${m}:${s<10?"0":""}${s}`;
        
        if(phase===0){
            phaseEl.className="signup";phaseEl.textContent="üìù SIGNUP";
            playEndTime=Date.now()+secs*1000+60000;
        }else if(phase===1){
            phaseEl.className="play";phaseEl.textContent="üéÆ PLAY";
            playEndTime=Date.now()+secs*1000;
        }else{
            phaseEl.className="signup";phaseEl.textContent="‚è≥ NEXT...";
        }
        
        registered=await contract.isRegistered(burner.address);
        joinBtn.textContent=registered?"‚úì Joined":"Join (10 MON)";
        joinBtn.classList.toggle("joined",registered);
        
        if(registered){
            myBestScore=(await contract.getMyScore()).toNumber();
            $("myScoreVal").textContent=myBestScore;
            $("myScore").classList.add("show");
        }else{
            $("myScore").classList.remove("show");
        }
        
        const[winners,lastHS,prizePerWinner,lastPlayers]=await contract.getLastResult();
        if(lastPlayers>0){
            $("lastResult").classList.add("show");
            if(lastPlayers===1){$("lastTitle").textContent="üí∏ Refunded";$("lastWinner").textContent="Solo player";$("lastPrize").textContent="";}
            else if(!winners.length||lastHS===0){$("lastTitle").textContent="üí∏ Refunded";$("lastWinner").textContent="No scores";$("lastPrize").textContent="";}
            else if(winners.length===1){$("lastTitle").textContent="üéâ Winner";$("lastWinner").textContent=fmt(winners[0]);$("lastPrize").textContent=`${(+ethers.utils.formatEther(prizePerWinner)).toFixed(1)} MON (score: ${lastHS})`;}
            else{$("lastTitle").textContent=`üéâ ${winners.length}-Way Tie`;$("lastWinner").textContent=winners.map(fmt).join(", ");$("lastPrize").textContent=`${(+ethers.utils.formatEther(prizePerWinner)).toFixed(1)} MON each`;}
        }
        
        updateUI();
        await updateBal();
    }catch(e){console.error(e);}
}

connectBtn.onclick=async()=>{
    if(!window.ethereum)return alert("Install MetaMask!");
    connectBtn.disabled=true;connectBtn.textContent="...";
    try{
        await window.ethereum.request({method:"eth_requestAccounts"});
        provider=new ethers.providers.Web3Provider(window.ethereum);
        const net=await provider.getNetwork();
        if(net.chainId!==10143){
            try{await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:CHAIN}]});}
            catch(e){if(e.code===4902)await window.ethereum.request({method:"wallet_addEthereumChain",params:[{chainId:CHAIN,chainName:"Monad Testnet",nativeCurrency:{name:"MON",symbol:"MON",decimals:18},rpcUrls:[RPC],blockExplorerUrls:[EXPLORER]}]});}
            provider=new ethers.providers.Web3Provider(window.ethereum);
        }
        signer=provider.getSigner();
        userAddr=await signer.getAddress();
        burner=getBurner();
        contract=new ethers.Contract(CONTRACT,ABI,burner);
        
        connectBtn.textContent=fmt(userAddr);connectBtn.classList.add("connected");
        $("walletAddr").textContent=burner.address;
        $("walletAddr").onclick=()=>{navigator.clipboard.writeText(burner.address);$("walletAddr").textContent="Copied!";setTimeout(()=>$("walletAddr").textContent=burner.address,1000);};
        $("wallet").style.display="block";
        
        setInterval(updateTimer,100);
        setInterval(updateTournament,3000);
        await updateTournament();
    }catch(e){console.error(e);connectBtn.textContent="Connect Wallet";}
    connectBtn.disabled=false;
};

async function fund(amt){
    if(!amt||!signer)return;
    try{
        connectBtn.textContent="...";
        await(await signer.sendTransaction({to:burner.address,value:ethers.utils.parseEther(amt.toString())})).wait();
        connectBtn.textContent=fmt(userAddr);
        await updateBal();
    }catch(e){console.error(e);connectBtn.textContent=fmt(userAddr);}
}
$("fundBtn").onclick=()=>fund(+$("fundAmt").value);
document.querySelectorAll(".quick button").forEach(b=>b.onclick=()=>fund(+b.dataset.v));
$("sendBtn").onclick=async()=>{
    const addr=$("sendAddr").value,amt=+$("sendAmt").value;
    if(!addr||!amt)return;
    try{await(await burner.sendTransaction({to:addr,value:ethers.utils.parseEther(amt.toString()),gasLimit:21000})).wait();updateBal();}catch(e){console.error(e);}
};

joinBtn.onclick=async()=>{
    if(registered||phase!==0)return;
    joinBtn.disabled=true;joinBtn.textContent="...";
    try{
        await(await contract.joinTournament({value:ethers.utils.parseEther("10"),gasLimit:200000})).wait();
        registered=true;joinBtn.textContent="‚úì Joined";joinBtn.classList.add("joined");
        updateTournament();
    }catch(e){console.error(e);joinBtn.textContent="Join (10 MON)";joinBtn.disabled=false;}
};

function updateTimer(){
    if(!contract)return;
    const now=Date.now(),rem=Math.max(0,playEndTime-now);
    const secs=Math.floor(rem/1000),m=Math.floor(secs/60),s=secs%60;
    timerEl.textContent=`${m}:${s<10?"0":""}${s}`;
    
    if(gameActive&&mode==="tournament"){
        gameTimer.textContent=`${m}:${s<10?"0":""}${s}`;
        gameTimer.classList.toggle("urgent",secs<=10);
        if(rem<=0)endGame("‚è±Ô∏è TIME!");
    }
    
    if(rem<=0)contract.advance().catch(()=>{});
}

function createBranch(side,y){
    const el=document.createElement("div");
    el.className="branch "+side;el.style.bottom=y+"px";
    el.innerHTML='<div class="branch-wood"></div><div class="branch-leaf"></div>';
    game.appendChild(el);
    return{side,y,el};
}

function initBranches(){
    document.querySelectorAll(".branch").forEach(b=>b.remove());
    branches=[];
    for(let i=0;i<8;i++)branches.push(createBranch(Math.random()>.5?"left":"right",160+i*65));
}

function startGame(){
    if(!burner||gameActive)return;
    const bal=+$("balAmt").textContent;
    if(bal<0.001)return;
    
    const isTourney=mode==="tournament"&&phase===1&&registered;
    if(mode==="tournament"&&!isTourney)return;
    
    score=0;timeLeft=100;gameActive=true;canRestart=false;
    startEl.classList.add("hidden");
    endEl.classList.remove("show");
    scoreEl.textContent="0";
    timefill.style.width="100%";timefill.className="";
    player.className="left";
    game.classList.toggle("tournament",isTourney);
    badge.classList.toggle("show",isTourney);
    gameTimer.classList.toggle("show",isTourney);
    
    initBranches();
    if(!isTourney)contract.startGame({gasLimit:50000}).catch(()=>{});
    requestAnimationFrame(loop);
}

function loop(){
    if(!gameActive)return;
    
    // Check tournament time
    if(mode==="tournament"&&phase===1&&playEndTime-Date.now()<=0){
        endGame("‚è±Ô∏è TIME!");return;
    }
    
    // Decay
    let decay=.08;
    if(score>=20)decay=.1;
    if(score>=40)decay=.14;
    if(score>=70)decay=.2;
    if(score>=100)decay=.28;
    
    timeLeft-=decay;
    const pct=Math.max(0,timeLeft);
    timefill.style.width=pct+"%";
    timefill.className=pct>50?"":pct>25?"warn":"danger";
    
    if(timeLeft<=0){endGame();return;}
    requestAnimationFrame(loop);
}

function chop(side){
    if(!gameActive)return;
    const now=Date.now();
    if(now-lastChop<50)return;
    lastChop=now;
    
    player.className=side;
    
    if(branches[0]?.side===side){endGame();return;}
    
    branches[0].el.remove();
    branches.shift();
    branches.forEach(b=>{b.y-=65;b.el.style.bottom=b.y+"px";});
    branches.push(createBranch(Math.random()>.5?"left":"right",branches[branches.length-1].y+65));
    
    score++;
    timeLeft=Math.min(100,timeLeft+5);
    scoreEl.textContent=score;
}

function endGame(reason){
    if(!gameActive)return;
    gameActive=false;
    game.classList.add("shake");
    setTimeout(()=>game.classList.remove("shake"),200);
    gameTimer.classList.remove("show");
    
    const isRecord=score>highScore;
    if(isRecord){highScore=score;localStorage.lumberjackHS=highScore;}
    
    $("finalScore").textContent=score;
    $("endMsg").textContent=reason||(isRecord?"üéâ NEW RECORD!":"Best: "+highScore);
    endEl.classList.toggle("record",isRecord);
    endEl.querySelector("h2").textContent=reason?"GAME OVER":(isRecord?"NEW RECORD!":"GAME OVER");
    
    const isTourney=game.classList.contains("tournament");
    const submitEl=$("submitStatus");
    
    if(isTourney&&registered&&score>0){
        submitEl.classList.add("show");
        submitEl.textContent="Submitting score...";
        contract.submitScore(score,{gasLimit:200000}).then(tx=>tx.wait()).then(()=>{
            submitEl.textContent="‚úÖ Score submitted!";
            if(score>myBestScore){myBestScore=score;$("myScoreVal").textContent=score;}
        }).catch(e=>{
            console.error(e);
            submitEl.textContent="‚ö†Ô∏è Submit failed";
        });
    }else{
        submitEl.classList.remove("show");
        if(!isTourney)contract.endGame(score,{gasLimit:50000}).catch(()=>{});
    }
    
    endEl.classList.add("show");
    setTimeout(()=>canRestart=true,500);
    updateBal();
}

function handleInput(side){
    if(!gameActive&&canRestart&&!startEl.classList.contains("hidden")){startGame();return;}
    if(!gameActive&&canRestart&&endEl.classList.contains("show")){
        endEl.classList.remove("show");
        startEl.classList.remove("hidden");
        updateUI();
        return;
    }
    chop(side);
}

document.querySelector(".zone.left").onclick=()=>handleInput("left");
document.querySelector(".zone.right").onclick=()=>handleInput("right");
document.querySelector(".zone.left").ontouchstart=e=>{e.preventDefault();handleInput("left");};
document.querySelector(".zone.right").ontouchstart=e=>{e.preventDefault();handleInput("right");};
$("restartBtn").onclick=()=>{endEl.classList.remove("show");startEl.classList.remove("hidden");updateUI();};

document.onkeydown=e=>{
    if([" ","ArrowLeft","ArrowRight"].includes(e.key))e.preventDefault();
    if(e.key==="ArrowLeft")handleInput("left");
    else if(e.key==="ArrowRight")handleInput("right");
    else if(e.key===" ")handleInput("left");
};
</script>
</body>
</html>
