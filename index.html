<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumberjack on Monad</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #2d5016;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        #gameArea {
            background: #8b4513;
            width: 400px;
            height: 500px;
            position: relative;
            border: 3px solid #654321;
            margin: 20px 0;
        }
        
        #tree {
            width: 100px;
            background: #654321;
            height: 100%;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        #lumberjack {
            width: 60px;
            height: 80px;
            background: #ff6b6b;
            position: absolute;
            bottom: 20px;
            left: 50px;
            transition: left 0.1s;
        }
        
        .branch {
            width: 80px;
            height: 30px;
            background: #228b22;
            position: absolute;
            border-radius: 15px;
        }
        
        .branch.left {
            left: 50px;
        }
        
        .branch.right {
            right: 50px;
        }
        
        #score {
            font-size: 24px;
            margin: 10px;
        }
        
        #wallet {
            margin: 10px;
            padding: 10px 20px;
            background: #4CAF50;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
        }
        
        #wallet:hover {
            background: #45a049;
        }
        
        #wallet.connected {
            background: #2196F3;
        }
        
        #status {
            margin: 10px;
            font-size: 14px;
            color: #ffeb3b;
        }
        
        #instructions {
            max-width: 500px;
            text-align: center;
            margin: 20px;
            line-height: 1.6;
        }
        
        #gameOver {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }
        
        #restartBtn {
            margin-top: 20px;
            padding: 10px 30px;
            background: #4CAF50;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            border-radius: 5px;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>ðŸª“ Lumberjack on Monad ðŸª“</h1>
    
    <button id="wallet">Connect MetaMask</button>
    <div id="status">Not connected</div>
    <div id="score">Score: 0 | Chops on Chain: 0</div>
    
    <div id="gameArea">
        <div id="tree"></div>
        <div id="lumberjack"></div>
        <div id="gameOver">
            <h2>Game Over!</h2>
            <p id="finalScore"></p>
            <button id="restartBtn">Play Again</button>
        </div>
    </div>
    
    <div id="instructions">
        <p><strong>How to Play:</strong></p>
        <p>Press <strong>LEFT ARROW</strong> or <strong>RIGHT ARROW</strong> to chop!</p>
        <p>Avoid branches on the side you're chopping from!</p>
        <p><strong>Each chop sends a transaction to Monad blockchain!</strong></p>
        <p>Make sure you have MON tokens for gas fees.</p>
    </div>

    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <script>
        // Game variables
        let score = 0;
        let onChainChops = 0;
        let gameActive = false;
        let lumberjackSide = 'left'; // 'left' or 'right'
        let branches = [];
        let provider;
        let signer;
        let userAddress;
        
        // Monad Mainnet Configuration
        const MONAD_CHAIN_ID = '0x8f'; // 143 in hex
        const MONAD_RPC = 'https://rpc.monad.xyz';
        
        // DOM elements
        const walletBtn = document.getElementById('wallet');
        const statusDiv = document.getElementById('status');
        const scoreDiv = document.getElementById('score');
        const lumberjack = document.getElementById('lumberjack');
        const gameArea = document.getElementById('gameArea');
        const gameOverDiv = document.getElementById('gameOver');
        const restartBtn = document.getElementById('restartBtn');
        const finalScoreDiv = document.getElementById('finalScore');
        
        // Connect wallet
        walletBtn.addEventListener('click', async () => {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask!');
                return;
            }
            
            try {
                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // Check if we're on Monad
                const network = await provider.getNetwork();
                if (network.chainId !== 143) {
                    // Try to switch to Monad
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: MONAD_CHAIN_ID }],
                        });
                    } catch (switchError) {
                        // If chain doesn't exist, add it
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: MONAD_CHAIN_ID,
                                    chainName: 'Monad Mainnet',
                                    nativeCurrency: {
                                        name: 'MON',
                                        symbol: 'MON',
                                        decimals: 18
                                    },
                                    rpcUrls: [MONAD_RPC],
                                    blockExplorerUrls: ['https://monadvision.com']
                                }]
                            });
                        } else {
                            throw switchError;
                        }
                    }
                }
                
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                walletBtn.textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                walletBtn.classList.add('connected');
                statusDiv.textContent = 'Connected to Monad! Press arrow keys to start playing.';
                
                gameActive = true;
                initGame();
                
            } catch (error) {
                console.error('Error connecting wallet:', error);
                statusDiv.textContent = 'Error connecting wallet: ' + error.message;
            }
        });
        
        // Initialize game
        function initGame() {
            score = 0;
            branches = [];
            lumberjackSide = 'left';
            gameOverDiv.style.display = 'none';
            updateScore();
            generateBranches();
            updateLumberjackPosition();
        }
        
        // Generate random branches
        function generateBranches() {
            // Clear existing branches
            document.querySelectorAll('.branch').forEach(b => b.remove());
            branches = [];
            
            // Create 5 branches at random positions
            for (let i = 0; i < 5; i++) {
                const side = Math.random() > 0.5 ? 'left' : 'right';
                const position = 100 + (i * 80); // Spread them out vertically
                branches.push({ side, position });
                
                const branchEl = document.createElement('div');
                branchEl.className = `branch ${side}`;
                branchEl.style.bottom = `${position}px`;
                gameArea.appendChild(branchEl);
            }
        }
        
        // Update lumberjack position
        function updateLumberjackPosition() {
            if (lumberjackSide === 'left') {
                lumberjack.style.left = '50px';
            } else {
                lumberjack.style.left = '290px';
            }
        }
        
        // Chop function (sends transaction)
        async function chop(side) {
            if (!gameActive || !signer) return;
            
            lumberjackSide = side;
            updateLumberjackPosition();
            
            // Check if hit a branch
            const lowestBranch = branches[0];
            if (lowestBranch && lowestBranch.position < 150 && lowestBranch.side === side) {
                endGame();
                return;
            }
            
            // Remove lowest branch
            if (branches.length > 0) {
                const branchToRemove = branches.shift();
                const branchEls = document.querySelectorAll('.branch');
                if (branchEls[0]) branchEls[0].remove();
                
                // Move remaining branches down
                branches.forEach((branch, index) => {
                    branch.position -= 80;
                    const branchEl = branchEls[index + 1];
                    if (branchEl) {
                        branchEl.style.bottom = `${branch.position}px`;
                    }
                });
                
                // Add new branch at top
                const newSide = Math.random() > 0.5 ? 'left' : 'right';
                const newPosition = 100 + (branches.length * 80);
                branches.push({ side: newSide, position: newPosition });
                
                const newBranchEl = document.createElement('div');
                newBranchEl.className = `branch ${newSide}`;
                newBranchEl.style.bottom = `${newPosition}px`;
                gameArea.appendChild(newBranchEl);
            }
            
            score++;
            updateScore();
            
            // Send transaction to Monad
            sendChopTransaction();
        }
        
        // Send transaction to blockchain
        async function sendChopTransaction() {
            try {
                statusDiv.textContent = 'Sending chop transaction...';
                
                // Simple transaction - just send 0 MON to yourself
                // This is the simplest way to record a chop on-chain
                const tx = await signer.sendTransaction({
                    to: userAddress,
                    value: ethers.utils.parseEther('0'),
                    data: ethers.utils.toUtf8Bytes(`Chop #${onChainChops + 1}`)
                });
                
                statusDiv.textContent = `Transaction sent! Hash: ${tx.hash.slice(0, 10)}...`;
                
                // Wait for confirmation (optional - game continues either way)
                tx.wait().then(() => {
                    onChainChops++;
                    updateScore();
                    statusDiv.textContent = 'Chop recorded on Monad! âœ…';
                });
                
            } catch (error) {
                console.error('Transaction error:', error);
                statusDiv.textContent = 'Transaction failed (but game continues)';
            }
        }
        
        // Update score display
        function updateScore() {
            scoreDiv.textContent = `Score: ${score} | Chops on Chain: ${onChainChops}`;
        }
        
        // End game
        function endGame() {
            gameActive = false;
            gameOverDiv.style.display = 'block';
            finalScoreDiv.textContent = `Final Score: ${score} | On-Chain Chops: ${onChainChops}`;
        }
        
        // Restart game
        restartBtn.addEventListener('click', () => {
            gameActive = true;
            initGame();
        });
        
        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (!gameActive) return;
            
            if (e.key === 'ArrowLeft') {
                chop('left');
            } else if (e.key === 'ArrowRight') {
                chop('right');
            }
        });
    </script>
</body>
</html>
