<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Monad Lumberjack Tournament</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Arial Black', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; padding: 10px; user-select: none;
        }
        #header { text-align: center; margin-bottom: 10px; }
        h1 {
            font-size: 28px; margin: 10px 0 5px 0;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        #highScoreDisplay { font-size: 14px; color: #feca57; }
        #mainContainer { display: flex; gap: 20px; align-items: flex-start; }
        
        #gameArea {
            background: linear-gradient(to bottom, #87CEEB 0%, #B0E0E6 100%);
            width: 380px; height: 600px; position: relative;
            border: 3px solid #5D4037; border-radius: 15px; overflow: hidden;
        }
        #gameArea.tournament { border-color: #9c27b0; box-shadow: 0 0 20px rgba(156,39,176,0.5); }
        #gameArea.shake { animation: shake 0.25s ease-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }
        
        .cloud { position: absolute; background: rgba(255,255,255,0.9); border-radius: 50px; z-index: 1; }
        .cloud::before, .cloud::after { content: ''; position: absolute; background: rgba(255,255,255,0.9); border-radius: 50%; }
        .cloud1 { width: 80px; height: 28px; top: 35px; left: 15px; }
        .cloud1::before { width: 40px; height: 40px; top: -20px; left: 15px; }
        .cloud1::after { width: 50px; height: 45px; top: -22px; left: 40px; }
        .cloud2 { width: 65px; height: 24px; top: 80px; right: 25px; }
        .cloud2::before { width: 32px; height: 32px; top: -16px; left: 12px; }
        .cloud2::after { width: 40px; height: 36px; top: -18px; left: 32px; }
        
        #trunk {
            position: absolute; left: 50%; transform: translateX(-50%);
            bottom: 80px; width: 52px; height: 560px;
            background: linear-gradient(to right, #4E342E 0%, #6D4C41 15%, #8D6E63 35%, #A1887F 50%, #8D6E63 65%, #6D4C41 85%, #4E342E 100%);
            z-index: 10;
        }
        
        .branch { position: absolute; left: 50%; height: 50px; z-index: 9; transition: bottom 0.1s ease-out; }
        .branch.left { transform: translateX(-26px) translateX(-100%); }
        .branch.right { transform: translateX(26px); }
        .branch-inner { position: relative; width: 95px; height: 50px; }
        .branch-wood { position: absolute; bottom: 18px; width: 50px; height: 14px; background: linear-gradient(to bottom, #A1887F 0%, #8D6E63 50%, #6D4C41 100%); }
        .branch.left .branch-wood { right: 0; border-radius: 8px 0 0 8px; }
        .branch.right .branch-wood { left: 0; border-radius: 0 8px 8px 0; }
        .branch-leaf { position: absolute; bottom: 5px; width: 52px; height: 44px; background: radial-gradient(ellipse at 50% 60%, #7ED67E 0%, #5CB85C 30%, #4CAF50 55%, #388E3C 80%, #2E7D32 100%); border-radius: 50%; }
        .branch.left .branch-leaf { left: 0; }
        .branch.right .branch-leaf { right: 0; }
        
        #ground { position: absolute; bottom: 0; width: 100%; height: 80px; background: linear-gradient(to bottom, #7CB342 0%, #689F38 40%, #558B2F 70%, #33691E 100%); z-index: 15; }
        #groundHighlight { position: absolute; bottom: 80px; width: 100%; height: 12px; background: linear-gradient(to bottom, #8BC34A 0%, #7CB342 100%); border-radius: 50% 50% 0 0 / 100% 100% 0 0; z-index: 15; }
        
        #lumberjack { position: absolute; bottom: 90px; width: 60px; height: 75px; z-index: 20; transition: left 0.08s ease-out; }
        #lumberjack.left { left: 70px; }
        #lumberjack.right { left: 250px; }
        
        #keoneImg { width: 36px; height: 36px; border-radius: 50%; border: 3px solid #5D4037; position: absolute; top: 0; left: 50%; transform: translateX(-50%); background: #FFCCBC; object-fit: cover; z-index: 2; }
        .lj-body { position: absolute; top: 31px; left: 50%; transform: translateX(-50%); width: 30px; height: 32px; background: #E53935; border-radius: 4px; }
        .lj-body::before { content: ''; position: absolute; inset: 3px; background: repeating-linear-gradient(90deg, #C62828 0px, #C62828 3px, #1A1A1A 3px, #1A1A1A 6px); border-radius: 2px; }
        .lj-pants { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); width: 26px; height: 16px; background: #1565C0; border-radius: 0 0 4px 4px; }
        #axe { position: absolute; top: 20px; font-size: 26px; z-index: 3; }
        #lumberjack.left #axe { right: -5px; transform: scaleX(-1); }
        #lumberjack.right #axe { left: -5px; transform: scaleX(1); }
        #axe.swing { animation: swing 0.06s ease-out; }
        @keyframes swing { 0%, 100% { rotate: 0deg; } 50% { rotate: -35deg; } }
        
        .wood-chip { position: absolute; border-radius: 2px; pointer-events: none; z-index: 50; }
        
        #bottomHUD { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; gap: 6px; z-index: 100; }
        #scoreDisplay { font-size: 36px; font-weight: bold; color: white; text-shadow: 2px 2px 0 #5D4037, 0 0 10px rgba(0,0,0,0.5); }
        #timeBarContainer { width: 160px; height: 12px; background: rgba(0,0,0,0.4); border-radius: 6px; overflow: hidden; border: 2px solid #5D4037; }
        #timeBarFill { height: 100%; width: 100%; background: linear-gradient(to right, #4CAF50, #8BC34A); transition: width 0.08s linear; }
        #timeBarFill.warning { background: linear-gradient(to right, #FF9800, #FFC107); }
        #timeBarFill.danger { background: linear-gradient(to right, #f44336, #FF5722); animation: pulseDanger 0.4s ease-in-out infinite; }
        @keyframes pulseDanger { 0%, 100% { box-shadow: 0 0 5px #f44336; } 50% { box-shadow: 0 0 15px #ff0000, 0 0 25px rgba(255,0,0,0.6); } }
        
        #tournamentBadge { display: none; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #9c27b0, #e91e63); padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 100; }
        #tournamentBadge.show { display: block; }
        
        .tap-zone { position: absolute; top: 0; width: 50%; height: 100%; z-index: 30; cursor: pointer; }
        .tap-zone.left { left: 0; }
        .tap-zone.right { right: 0; }
        
        #sidePanel { display: flex; flex-direction: column; gap: 10px; width: 280px; }
        .panel-box { background: rgba(255,255,255,0.05); padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .panel-box h3 { font-size: 12px; margin-bottom: 8px; opacity: 0.7; font-weight: normal; }
        button { padding: 10px 14px; font-size: 13px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; width: 100%; color: white; transition: transform 0.1s, opacity 0.1s; }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #connectBtn { background: linear-gradient(135deg, #667eea, #764ba2); }
        #connectBtn.connected { background: linear-gradient(135deg, #11998e, #38ef7d); font-size: 11px; }
        
        .wallet-info { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; margin-top: 8px; font-size: 10px; text-align: center; }
        .wallet-info .balance { font-size: 18px; font-weight: bold; color: #8BC34A; margin: 6px 0; }
        .wallet-info .address { font-size: 9px; opacity: 0.6; word-break: break-all; cursor: pointer; }
        
        .action-row { display: flex; gap: 6px; margin-top: 8px; }
        .action-row input { flex: 1; padding: 8px; border-radius: 6px; border: none; font-size: 11px; min-width: 0; }
        .action-row button { width: auto; padding: 8px 12px; font-size: 11px; }
        .btn-fund { background: linear-gradient(135deg, #4CAF50, #8BC34A); }
        .btn-withdraw { background: linear-gradient(135deg, #ff9800, #f57c00); }
        
        .quick-fund { display: flex; gap: 4px; margin-top: 6px; }
        .quick-fund button { flex: 1; padding: 6px; font-size: 10px; background: rgba(255,255,255,0.1); }
        
        #walletSection { display: none; }
        
        .tournament-box { background: linear-gradient(135deg, rgba(156,39,176,0.2), rgba(233,30,99,0.2)); border: 1px solid rgba(156,39,176,0.4); }
        .tournament-box h3 { color: #e91e63; opacity: 1; font-size: 13px; }
        
        #phaseIndicator { text-align: center; margin-bottom: 8px; padding: 8px; border-radius: 8px; font-size: 14px; font-weight: bold; }
        #phaseIndicator.signup { background: rgba(76,175,80,0.3); color: #8BC34A; }
        #phaseIndicator.play { background: rgba(233,30,99,0.3); color: #e91e63; }
        #phaseIndicator.ended { background: rgba(255,152,0,0.3); color: #FFC107; }
        
        #tournamentTimer { font-size: 32px; font-weight: bold; text-align: center; color: #feca57; margin: 5px 0; }
        .tournament-stats { display: flex; justify-content: space-around; margin: 10px 0; text-align: center; }
        .tournament-stats .stat-val { font-size: 18px; font-weight: bold; color: #8BC34A; }
        .tournament-stats .stat-label { font-size: 9px; opacity: 0.7; }
        
        #joinTournamentBtn { background: linear-gradient(135deg, #9c27b0, #e91e63); font-size: 13px; margin-top: 8px; }
        #joinTournamentBtn.joined { background: linear-gradient(135deg, #4CAF50, #8BC34A); }
        
        #lastWinner { margin-top: 10px; padding: 10px; background: rgba(76,175,80,0.2); border-radius: 8px; text-align: center; font-size: 11px; display: none; }
        #lastWinner.show { display: block; }
        #lastWinner .winner-addr { color: #8BC34A; font-weight: bold; font-size: 13px; }
        #lastWinner .winner-prize { color: #feca57; }
        
        #myTournamentScore { margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; text-align: center; font-size: 11px; display: none; }
        #myTournamentScore.show { display: block; }
        
        .instructions { font-size: 10px; opacity: 0.6; text-align: center; line-height: 1.4; }
        
        #startOverlay { position: absolute; inset: 0; background: rgba(0,0,0,0.75); z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        #startOverlay.hidden { display: none; }
        #startOverlay h2 { font-size: 22px; margin-bottom: 10px; }
        #startOverlay p { font-size: 13px; opacity: 0.85; margin: 4px 0; }
        #tapToStart { margin-top: 16px; font-size: 14px; color: #feca57; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        
        #gameOver { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; opacity: 0; pointer-events: none; }
        #gameOver.show { display: flex; animation: fadeIn 0.6s ease-out forwards; }
        #gameOver.show.canRestart { pointer-events: auto; }
        @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
        #gameOver h2 { font-size: 22px; color: #f5576c; margin-bottom: 5px; }
        #gameOver.newRecord h2 { color: #feca57; }
        #finalScore { font-size: 48px; font-weight: bold; color: white; margin: 6px 0; }
        #txSummary { font-size: 13px; color: #9c27b0; margin: 6px 0; padding: 6px 14px; background: rgba(156,39,176,0.2); border-radius: 10px; }
        #tournamentSubmit { display: none; font-size: 13px; color: #8BC34A; margin: 8px 0; padding: 8px 16px; background: rgba(76,175,80,0.2); border-radius: 10px; }
        #tournamentSubmit.show { display: block; }
        #beatScore { font-size: 11px; color: #feca57; margin: 4px 0; }
        #restartBtn { background: linear-gradient(135deg, #f5576c, #f093fb); margin-top: 12px; font-size: 14px; padding: 10px 28px; width: auto; }
        #txLink { margin-top: 8px; }
        #txLink a { color: #54a0ff; text-decoration: none; font-size: 11px; }
        
        @media (max-width: 700px) {
            #mainContainer { flex-direction: column; align-items: center; }
            #sidePanel { width: 380px; max-width: 100%; }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>ü™ì MONAD LUMBERJACK</h1>
        <div id="highScoreDisplay">üèÜ Best: <span id="highScoreTop">0</span></div>
    </div>
    
    <div id="mainContainer">
        <div id="gameArea">
            <div class="cloud cloud1"></div>
            <div class="cloud cloud2"></div>
            <div id="trunk"></div>
            <div id="tournamentBadge">üèÜ TOURNAMENT</div>
            
            <div id="lumberjack" class="left">
                <img src="keone.png" alt="" id="keoneImg" onerror="this.style.background='#FFCCBC'">
                <div class="lj-body"></div>
                <div class="lj-pants"></div>
                <div id="axe">ü™ì</div>
            </div>
            
            <div id="groundHighlight"></div>
            <div id="ground"></div>
            
            <div id="bottomHUD">
                <div id="scoreDisplay">0</div>
                <div id="timeBarContainer"><div id="timeBarFill"></div></div>
            </div>
            
            <div class="tap-zone left" id="tapLeft"></div>
            <div class="tap-zone right" id="tapRight"></div>
            
            <div id="startOverlay">
                <h2>ü™ì TAP TO CHOP</h2>
                <p>‚¨ÖÔ∏è Left = chop left</p>
                <p>‚û°Ô∏è Right = chop right</p>
                <p>üåø Avoid branches!</p>
                <div id="tapToStart">CONNECT WALLET TO PLAY</div>
            </div>
            
            <div id="gameOver">
                <h2>GAME OVER</h2>
                <div id="finalScore">0</div>
                <div id="txSummary">‚ö° 0 transactions</div>
                <div id="tournamentSubmit">üèÜ Score submitted to tournament!</div>
                <div id="beatScore"></div>
                <div id="txLink"></div>
                <button id="restartBtn">PLAY AGAIN (SPACE)</button>
            </div>
        </div>
        
        <div id="sidePanel">
            <div class="panel-box">
                <button id="connectBtn">Connect Wallet</button>
                <div id="walletSection">
                    <div class="wallet-info">
                        <div>Game Wallet</div>
                        <div class="balance"><span id="balanceAmt">0</span> MON</div>
                        <div class="address" id="walletAddr" title="Click to copy">-</div>
                    </div>
                    <div class="action-row">
                        <input type="number" id="fundAmt" placeholder="Amount">
                        <button class="btn-fund" id="fundBtn">Deposit</button>
                    </div>
                    <div class="quick-fund">
                        <button data-amt="1">1</button>
                        <button data-amt="5">5</button>
                        <button data-amt="15">15</button>
                        <button data-amt="25">25</button>
                    </div>
                    <div class="action-row" style="margin-top: 10px;">
                        <input type="text" id="withdrawAddr" placeholder="0x...">
                        <input type="number" id="withdrawAmt" placeholder="Amt" style="width: 50px; flex: none;">
                        <button class="btn-withdraw" id="withdrawBtn">Send</button>
                    </div>
                </div>
            </div>
            
            <div class="panel-box tournament-box">
                <h3>üèÜ TOURNAMENT #<span id="tournamentNum">1</span></h3>
                <div id="phaseIndicator" class="signup">üìù SIGNUP PHASE</div>
                <div id="tournamentTimer">5:00</div>
                <div class="tournament-stats">
                    <div><div class="stat-val" id="prizePool">0</div><div class="stat-label">Prize (MON)</div></div>
                    <div><div class="stat-val" id="playerCount">0</div><div class="stat-label">Players</div></div>
                    <div><div class="stat-val" id="highScoreTourney">0</div><div class="stat-label">High Score</div></div>
                </div>
                <button id="joinTournamentBtn" disabled>Join Tournament (10 MON)</button>
                <div id="myTournamentScore">Your tournament score: <span id="myScoreVal">0</span></div>
                <div id="lastWinner">
                    <div id="lastWinnerTitle">üéâ Last Winner</div>
                    <div class="winner-addr" id="winnerAddr">-</div>
                    <div class="winner-prize" id="winnerPrizeText">Won <span id="winnerPrize">0</span> MON</div>
                </div>
            </div>
            
            <div class="instructions">
                <div style="font-size:12px;font-weight:bold;margin-bottom:6px;color:#feca57;">HOW TOURNAMENTS WORK</div>
                üìù <b>Signup (5 min)</b>: Pay 10 MON to enter. Practice for free!<br>
                üéÆ <b>Play (5 min)</b>: Compete! Only your highest score counts.<br>
                üèÜ <b>Winner</b>: Highest score takes the entire prize pool!<br>
                <div style="margin-top:6px;opacity:0.5;">Ties split the pool. Solo player = refunded.</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        var CONTRACT = "0xe94e756785FEc2e8c61f6A0fd3EfE571e1Ce72D6";
        var ABI = [
            "function startGame(address) external",
            "function chop(address,uint256) external",
            "function endGame(address,uint256) external",
            "function joinTournament() external payable",
            "function submitScore(uint256) external",
            "function advanceTournament() external",
            "function getTournamentInfo() external view returns (uint256,uint256,uint256,uint256,uint256,uint256,uint8,bool)",
            "function isPlayerRegistered(uint256,address) external view returns (bool)",
            "function getPlayerScore(uint256,address) external view returns (uint256)",
            "function getLastTournamentResult() external view returns (uint256,address[],uint256,uint256,uint256)",
            "function currentTournamentId() external view returns (uint256)"
        ];
        var CHAIN_ID = "0x279f";
        var RPC = "https://testnet-rpc.monad.xyz";
        var EXPLORER = "https://testnet.monadexplorer.com";
        
        var score = 0;
        var highScore = 0;
        var gameActive = false;
        var playerSide = "left";
        var branches = [];
        var timeLeft = 100;
        var txCount = 0;
        var canRestart = false;
        var provider, signer, userAddress, burner, contract, animFrame;
        var lastChopTime = 0;
        var isRegistered = false;
        var currentTournamentId = 0;
        var myCurrentTournamentScore = 0;
        var tournamentPhase = 0;
        var signupEndTime = 0;
        var playEndTime = 0;
        
        function $(id) { return document.getElementById(id); }
        
        var gameArea = $("gameArea");
        var scoreDisplay = $("scoreDisplay");
        var timeBar = $("timeBarFill");
        var lumberjack = $("lumberjack");
        var axe = $("axe");
        var startOverlay = $("startOverlay");
        var gameOver = $("gameOver");
        var connectBtn = $("connectBtn");
        var tapToStart = $("tapToStart");
        var highScoreEl = $("highScoreTop");
        var walletSection = $("walletSection");
        var balanceAmt = $("balanceAmt");
        var walletAddr = $("walletAddr");
        var tournamentBadge = $("tournamentBadge");
        var joinBtn = $("joinTournamentBtn");
        var phaseIndicator = $("phaseIndicator");
        
        highScore = parseInt(localStorage.getItem("lumberjackHS") || "0");
        highScoreEl.textContent = highScore;
        
        var deathSound = null;
        
        function initAudio() {
            Tone.start().then(function() {
                deathSound = new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 4,
                    envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 0.3 }
                }).toDestination();
                deathSound.volume.value = -8;
            }).catch(function(e) { console.error(e); });
        }
        
        function playDeathSound() {
            if (deathSound) {
                deathSound.triggerAttackRelease("G2", "8n");
                setTimeout(function() { deathSound.triggerAttackRelease("D2", "8n"); }, 100);
                setTimeout(function() { deathSound.triggerAttackRelease("A1", "4n"); }, 200);
            }
        }
        
        function spawnChips(fromLeft) {
            var x = fromLeft ? 155 : 220;
            var y = 400;
            for (var i = 0; i < 6; i++) {
                var chip = document.createElement("div");
                chip.className = "wood-chip";
                var sz = 4 + Math.random() * 6;
                var colors = ["#8D6E63", "#A1887F", "#6D4C41"];
                chip.style.cssText = "width:" + sz + "px;height:" + (sz * 0.7) + "px;background:" + colors[i % 3] + ";left:" + x + "px;top:" + y + "px;";
                gameArea.appendChild(chip);
                animateChip(chip, x, y, fromLeft);
            }
        }
        
        function animateChip(chip, startX, startY, fromLeft) {
            var vx = (2 + Math.random() * 4) * (fromLeft ? -1 : 1);
            var vy = -3 - Math.random() * 4;
            var cx = startX;
            var cy = startY;
            var op = 1;
            
            function animate() {
                cx += vx;
                cy += vy;
                vy += 0.35;
                op -= 0.03;
                chip.style.left = cx + "px";
                chip.style.top = cy + "px";
                chip.style.opacity = op;
                if (op > 0) {
                    requestAnimationFrame(animate);
                } else {
                    chip.remove();
                }
            }
            requestAnimationFrame(animate);
        }
        
        function getBurner() {
            var pk = localStorage.getItem("lumberjackPK");
            if (!pk) {
                pk = ethers.Wallet.createRandom().privateKey;
                localStorage.setItem("lumberjackPK", pk);
            }
            return new ethers.Wallet(pk, new ethers.providers.JsonRpcProvider(RPC));
        }
        
        function updateBal() {
            if (!burner) return Promise.resolve(0);
            return burner.getBalance().then(function(bal) {
                var b = parseFloat(ethers.utils.formatEther(bal));
                balanceAmt.textContent = b.toFixed(3);
                joinBtn.disabled = b < 10 || isRegistered || tournamentPhase !== 0;
                updateTapToStart(b);
                return b;
            });
        }
        
        function updateTapToStart(bal) {
            if (bal < 0.001) {
                tapToStart.textContent = "DEPOSIT MON TO PLAY";
            } else {
                tapToStart.textContent = "TAP OR PRESS SPACE TO START";
            }
        }
        
        function formatAddr(addr) {
            return addr.slice(0, 6) + "..." + addr.slice(-4);
        }
        
        function updateTournamentInfo() {
            if (!contract) return Promise.resolve();
            
            return contract.getTournamentInfo().then(function(info) {
                currentTournamentId = info[0].toNumber();
                signupEndTime = info[1].toNumber() * 1000;
                playEndTime = info[2].toNumber() * 1000;
                var prize = parseFloat(ethers.utils.formatEther(info[3]));
                var players = info[4].toNumber();
                var high = info[5].toNumber();
                tournamentPhase = info[6];
                
                $("tournamentNum").textContent = currentTournamentId;
                $("prizePool").textContent = prize.toFixed(0);
                $("playerCount").textContent = players;
                $("highScoreTourney").textContent = high;
                
                if (tournamentPhase === 0) {
                    phaseIndicator.className = "signup";
                    phaseIndicator.textContent = "üìù SIGNUP PHASE";
                    joinBtn.textContent = isRegistered ? "‚úì Registered" : "Join Tournament (10 MON)";
                } else if (tournamentPhase === 1) {
                    phaseIndicator.className = "play";
                    phaseIndicator.textContent = "üéÆ PLAY PHASE";
                    joinBtn.textContent = "Signup Closed";
                } else {
                    phaseIndicator.className = "ended";
                    phaseIndicator.textContent = "‚è≥ FINALIZING...";
                    joinBtn.textContent = "Next Round Soon";
                    contract.advanceTournament({ gasLimit: 500000 }).catch(function() {});
                }
                
                if (burner) {
                    return contract.isPlayerRegistered(currentTournamentId, burner.address).then(function(reg) {
                        isRegistered = reg;
                        joinBtn.classList.toggle("joined", isRegistered);
                        
                        if (isRegistered) {
                            return contract.getPlayerScore(currentTournamentId, burner.address).then(function(myScore) {
                                myCurrentTournamentScore = myScore.toNumber();
                                $("myScoreVal").textContent = myCurrentTournamentScore;
                                $("myTournamentScore").classList.add("show");
                            });
                        } else {
                            myCurrentTournamentScore = 0;
                            $("myTournamentScore").classList.remove("show");
                        }
                    });
                }
            }).then(function() {
                return contract.getLastTournamentResult();
            }).then(function(last) {
                var lastId = last[0].toNumber();
                var winners = last[1];
                var lastHighScore = last[2].toNumber();
                var prizePerWinner = parseFloat(ethers.utils.formatEther(last[3]));
                var lastPlayerCount = last[4].toNumber();
                
                if (lastId > 0) {
                    $("lastWinner").classList.add("show");
                    
                    if (lastPlayerCount === 0) {
                        $("lastWinnerTitle").textContent = "üì≠ Last Tournament";
                        $("winnerAddr").textContent = "No players joined";
                        $("winnerPrizeText").textContent = "";
                    } else if (lastPlayerCount === 1) {
                        $("lastWinnerTitle").textContent = "üí∏ Last Tournament";
                        $("winnerAddr").textContent = "Only 1 player - refunded";
                        $("winnerPrizeText").textContent = "";
                    } else if (winners.length === 0 || lastHighScore === 0) {
                        $("lastWinnerTitle").textContent = "üí∏ Last Tournament";
                        $("winnerAddr").textContent = "No scores - all refunded";
                        $("winnerPrizeText").textContent = "";
                    } else if (winners.length === 1) {
                        $("lastWinnerTitle").textContent = "üéâ Last Winner";
                        $("winnerAddr").textContent = formatAddr(winners[0]);
                        $("winnerPrizeText").innerHTML = "Won " + prizePerWinner.toFixed(1) + " MON (score: " + lastHighScore + ")";
                    } else {
                        $("lastWinnerTitle").textContent = "üéâ " + winners.length + "-Way Tie!";
                        var winnerStrs = [];
                        for (var i = 0; i < winners.length; i++) {
                            winnerStrs.push(formatAddr(winners[i]));
                        }
                        $("winnerAddr").textContent = winnerStrs.join(", ");
                        $("winnerPrizeText").innerHTML = "Each won " + prizePerWinner.toFixed(1) + " MON (score: " + lastHighScore + ")";
                    }
                }
            }).then(function() {
                return updateBal();
            }).catch(function(e) {
                console.error("Tournament info error:", e);
            });
        }
        
        function updateTimer() {
            var now = Date.now();
            var remaining;
            
            if (tournamentPhase === 0) {
                remaining = Math.max(0, signupEndTime - now);
            } else if (tournamentPhase === 1) {
                remaining = Math.max(0, playEndTime - now);
            } else {
                remaining = 0;
            }
            
            var secs = Math.floor(remaining / 1000);
            var mins = Math.floor(secs / 60);
            var s = secs % 60;
            $("tournamentTimer").textContent = mins + ":" + (s < 10 ? "0" : "") + s;
            
            if (remaining === 0 && contract) {
                updateTournamentInfo();
            }
        }
        
        connectBtn.onclick = function() {
            if (!window.ethereum) {
                alert("Please install MetaMask!");
                return;
            }
            
            connectBtn.textContent = "Connecting...";
            connectBtn.disabled = true;
            
            window.ethereum.request({ method: "eth_requestAccounts" }).then(function(accounts) {
                if (!accounts || accounts.length === 0) {
                    throw new Error("No accounts");
                }
                provider = new ethers.providers.Web3Provider(window.ethereum);
                return provider.getNetwork();
            }).then(function(net) {
                if (net.chainId !== 10143) {
                    return window.ethereum.request({ 
                        method: "wallet_switchEthereumChain", 
                        params: [{ chainId: CHAIN_ID }] 
                    }).catch(function(e) {
                        if (e.code === 4902) {
                            return window.ethereum.request({
                                method: "wallet_addEthereumChain",
                                params: [{
                                    chainId: CHAIN_ID,
                                    chainName: "Monad Testnet",
                                    nativeCurrency: { name: "MON", symbol: "MON", decimals: 18 },
                                    rpcUrls: [RPC],
                                    blockExplorerUrls: [EXPLORER]
                                }]
                            });
                        }
                        throw e;
                    }).then(function() {
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                    });
                }
            }).then(function() {
                signer = provider.getSigner();
                return signer.getAddress();
            }).then(function(addr) {
                userAddress = addr;
                burner = getBurner();
                contract = new ethers.Contract(CONTRACT, ABI, burner);
                
                connectBtn.textContent = formatAddr(userAddress);
                connectBtn.classList.add("connected");
                connectBtn.disabled = false;
                
                walletAddr.textContent = burner.address;
                walletAddr.onclick = function() {
                    navigator.clipboard.writeText(burner.address);
                    walletAddr.textContent = "Copied!";
                    setTimeout(function() { walletAddr.textContent = burner.address; }, 1000);
                };
                walletSection.style.display = "block";
                
                initAudio();
                
                setInterval(updateTimer, 1000);
                setInterval(updateTournamentInfo, 10000);
                
                return updateTournamentInfo();
            }).catch(function(e) {
                console.error("Connection error:", e);
                connectBtn.textContent = "Connect Wallet";
                connectBtn.disabled = false;
            });
        };
        
        function fund(amt) {
            if (!amt || amt <= 0 || !signer) return;
            
            signer.sendTransaction({ 
                to: burner.address, 
                value: ethers.utils.parseEther(amt.toString()) 
            }).then(function(tx) {
                connectBtn.textContent = "Depositing...";
                return tx.wait();
            }).then(function() {
                connectBtn.textContent = formatAddr(userAddress);
                return updateBal();
            }).catch(function(e) {
                console.error(e);
                connectBtn.textContent = formatAddr(userAddress);
            });
        }
        
        $("fundBtn").onclick = function() { fund(parseFloat($("fundAmt").value)); };
        
        var quickFundBtns = document.querySelectorAll(".quick-fund button");
        for (var i = 0; i < quickFundBtns.length; i++) {
            quickFundBtns[i].onclick = function() { fund(parseFloat(this.dataset.amt)); };
        }
        
        $("withdrawBtn").onclick = function() {
            var addr = $("withdrawAddr").value.trim();
            var amt = parseFloat($("withdrawAmt").value);
            if (!addr || !amt) return;
            
            burner.sendTransaction({ 
                to: addr, 
                value: ethers.utils.parseEther(amt.toString()), 
                gasLimit: 21000 
            }).then(function(tx) {
                return tx.wait();
            }).then(function() {
                return updateBal();
            }).catch(function(e) { console.error(e); });
        };
        
        joinBtn.onclick = function() {
            if (!burner || isRegistered || tournamentPhase !== 0) return;
            
            joinBtn.textContent = "Joining...";
            joinBtn.disabled = true;
            
            contract.joinTournament({ 
                value: ethers.utils.parseEther("10"), 
                gasLimit: 300000 
            }).then(function(tx) {
                joinBtn.textContent = "Confirming...";
                return tx.wait();
            }).then(function() {
                isRegistered = true;
                joinBtn.textContent = "‚úì Registered";
                joinBtn.classList.add("joined");
                return updateTournamentInfo();
            }).catch(function(e) {
                console.error("Join error:", e);
                joinBtn.textContent = "Join Tournament (10 MON)";
                joinBtn.disabled = false;
                updateBal();
            });
        };
        
        function createBranch(side, y) {
            var el = document.createElement("div");
            el.className = "branch " + side;
            el.style.bottom = y + "px";
            el.innerHTML = '<div class="branch-inner"><div class="branch-wood"></div><div class="branch-leaf"></div></div>';
            gameArea.appendChild(el);
            return el;
        }
        
        function initBranches() {
            var existingBranches = document.querySelectorAll(".branch");
            for (var i = 0; i < existingBranches.length; i++) {
                existingBranches[i].remove();
            }
            branches = [];
            for (var j = 0; j < 8; j++) {
                var side = Math.random() > 0.5 ? "left" : "right";
                var y = 165 + j * 70;
                var el = createBranch(side, y);
                branches.push({ side: side, y: y, el: el });
            }
        }
        
        function startGame() {
            if (!burner) return;
            var bal = parseFloat(balanceAmt.textContent);
            if (bal < 0.001) return;
            if (!canRestart && gameOver.classList.contains("show")) return;
            
            var isTournamentGame = tournamentPhase === 1 && isRegistered;
            
            score = 0;
            txCount = 0;
            timeLeft = 100;
            playerSide = "left";
            gameActive = true;
            canRestart = false;
            
            startOverlay.classList.add("hidden");
            gameOver.classList.remove("show", "canRestart", "newRecord");
            gameOver.style.display = "none";
            scoreDisplay.textContent = "0";
            timeBar.style.width = "100%";
            timeBar.className = "";
            lumberjack.className = "left";
            gameArea.classList.remove("shake");
            
            if (isTournamentGame) {
                gameArea.classList.add("tournament");
                tournamentBadge.classList.add("show");
            } else {
                gameArea.classList.remove("tournament");
                tournamentBadge.classList.remove("show");
            }
            
            initBranches();
            
            if (!isTournamentGame) {
                contract.startGame(userAddress, { gasLimit: 100000 }).catch(function() {});
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        function gameLoop() {
            if (!gameActive) return;
            
            var decay = 0.08;
            if (score >= 15) decay = 0.10;
            if (score >= 30) decay = 0.13;
            if (score >= 50) decay = 0.17;
            if (score >= 75) decay = 0.22;
            if (score >= 100) decay = 0.28;
            
            timeLeft -= decay;
            var pct = Math.max(0, timeLeft);
            timeBar.style.width = pct + "%";
            
            if (pct > 50) {
                timeBar.className = "";
            } else if (pct > 25) {
                timeBar.className = "warning";
            } else {
                timeBar.className = "danger";
            }
            
            if (timeLeft <= 0) {
                endGame();
                return;
            }
            
            animFrame = requestAnimationFrame(gameLoop);
        }
        
        function chop(side) {
            if (!gameActive) return;
            
            var now = Date.now();
            if (now - lastChopTime < 60) return;
            lastChopTime = now;
            
            playerSide = side;
            lumberjack.className = side;
            
            axe.classList.remove("swing");
            void axe.offsetWidth;
            axe.classList.add("swing");
            
            spawnChips(side === "left");
            
            if (branches[0] && branches[0].side === side) {
                endGame();
                return;
            }
            
            branches[0].el.remove();
            branches.shift();
            
            for (var i = 0; i < branches.length; i++) {
                branches[i].y -= 70;
                branches[i].el.style.bottom = branches[i].y + "px";
            }
            
            var newSide = Math.random() > 0.5 ? "left" : "right";
            var newY = branches[branches.length - 1].y + 70;
            var newEl = createBranch(newSide, newY);
            branches.push({ side: newSide, y: newY, el: newEl });
            
            score++;
            txCount++;
            timeLeft = Math.min(100, timeLeft + 6);
            scoreDisplay.textContent = score;
            
            // Always send chop transaction, tournament or not
            contract.chop(userAddress, score, { gasLimit: 100000 }).catch(function() {});
        }
        
        function endGame() {
            gameActive = false;
            cancelAnimationFrame(animFrame);
            
            var isTournamentGame = gameArea.classList.contains("tournament");
            
            gameArea.classList.add("shake");
            playDeathSound();
            setTimeout(function() { gameArea.classList.remove("shake"); }, 250);
            
            var isRecord = score > highScore;
            if (isRecord) {
                highScore = score;
                localStorage.setItem("lumberjackHS", highScore);
                highScoreEl.textContent = highScore;
            }
            
            $("finalScore").textContent = score;
            $("txSummary").textContent = "‚ö° " + txCount + " chops";
            $("beatScore").textContent = isRecord ? "üéâ NEW RECORD!" : "Best: " + highScore;
            
            if (isRecord) gameOver.classList.add("newRecord");
            
            if (isTournamentGame) {
                $("tournamentSubmit").classList.add("show");
                if (score > myCurrentTournamentScore) {
                    $("tournamentSubmit").textContent = "üèÜ Submitting score " + score + "...";
                } else {
                    $("tournamentSubmit").textContent = "Score " + score + " (your best: " + myCurrentTournamentScore + ")";
                }
            } else {
                $("tournamentSubmit").classList.remove("show");
            }
            
            gameOver.querySelector("h2").textContent = isRecord ? "üéâ NEW RECORD!" : "GAME OVER";
            gameOver.style.display = "flex";
            gameOver.classList.add("show");
            
            setTimeout(function() {
                canRestart = true;
                gameOver.classList.add("canRestart");
            }, 800);
            
            submitGameResults(isTournamentGame, score);
        }
        
        function submitGameResults(isTournamentGame, finalScore) {
            if (isTournamentGame && isRegistered && finalScore > myCurrentTournamentScore) {
                // Submit score with retries, regardless of phase timing
                var submitAttempts = 0;
                var maxAttempts = 3;
                
                function trySubmit() {
                    submitAttempts++;
                    contract.submitScore(finalScore, { gasLimit: 300000 }).then(function(tx) {
                        $("tournamentSubmit").textContent = "üèÜ Confirming " + finalScore + "...";
                        return tx.wait();
                    }).then(function(receipt) {
                        $("tournamentSubmit").textContent = "üèÜ Score " + finalScore + " confirmed!";
                        $("txLink").innerHTML = '<a href="' + EXPLORER + '/tx/' + receipt.transactionHash + '" target="_blank">View on Explorer ‚Üí</a>';
                        myCurrentTournamentScore = finalScore;
                        $("myScoreVal").textContent = finalScore;
                        setTimeout(updateTournamentInfo, 1000);
                    }).catch(function(err) {
                        console.error("Score submit failed (attempt " + submitAttempts + "):", err);
                        
                        // Retry if we haven't hit max attempts
                        if (submitAttempts < maxAttempts) {
                            $("tournamentSubmit").textContent = "üîÑ Retrying score submit...";
                            setTimeout(trySubmit, 1000);
                        } else {
                            $("tournamentSubmit").textContent = "‚ö†Ô∏è Submit failed - score may not count";
                        }
                    });
                }
                
                trySubmit();
            } else if (!isTournamentGame) {
                contract.endGame(userAddress, finalScore, { gasLimit: 150000 }).catch(function() {});
            }
            
            updateBal();
        }
        
        $("restartBtn").onclick = startGame;
        
        function handleTap(side) {
            if (!gameActive) {
                if (canRestart || !gameOver.classList.contains("show")) {
                    startGame();
                }
            } else {
                chop(side);
            }
        }
        
        $("tapLeft").onclick = function() { handleTap("left"); };
        $("tapRight").onclick = function() { handleTap("right"); };
        $("tapLeft").ontouchstart = function(e) { e.preventDefault(); handleTap("left"); };
        $("tapRight").ontouchstart = function(e) { e.preventDefault(); handleTap("right"); };
        
        document.onkeydown = function(e) {
            if (e.key === " " || e.key === "ArrowLeft" || e.key === "ArrowRight") {
                e.preventDefault();
            }
            if (gameOver.classList.contains("show") && canRestart && (e.key === " " || e.key === "ArrowLeft" || e.key === "ArrowRight")) {
                startGame();
                return;
            }
            if (e.key === " " && !gameActive && !gameOver.classList.contains("show")) {
                startGame();
            }
            if (e.key === "ArrowLeft") handleTap("left");
            if (e.key === "ArrowRight") handleTap("right");
        };
    </script>
</body>
</html>
