<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Monad Lumberjack</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Arial Black', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
            user-select: none;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Cpath d='M30 5 L35 25 L55 30 L35 35 L30 55 L25 35 L5 30 L25 25 Z' fill='%236E54FF' fill-opacity='0.04'/%3E%3C/svg%3E");
            background-size: 60px 60px;
            pointer-events: none;
            z-index: 0;
        }
        
        #header, #mainContainer {
            position: relative;
            z-index: 1;
        }
        
        #header {
            text-align: center;
            margin-bottom: 10px;
        }
        
        h1 {
            font-size: 36px;
            margin: 10px 0 5px 0;
            text-shadow: 0 0 20px rgba(138, 43, 226, 0.8), 2px 2px 4px rgba(0,0,0,0.5);
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        #highScoreDisplay {
            font-size: 16px;
            color: #feca57;
            text-shadow: 0 0 10px rgba(254, 202, 87, 0.5);
        }
        
        #mainContainer {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            max-width: 100%;
        }
        
        #gameWrapper {
            position: relative;
        }
        
        #gameArea {
            background: linear-gradient(to bottom, #1a1a2e 0%, #2d3436 100%);
            width: 380px;
            height: 640px;
            position: relative;
            border: 3px solid #9c27b0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(156, 39, 176, 0.4), inset 0 0 60px rgba(0,0,0,0.5);
        }
        
        #ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 80px;
            background: linear-gradient(to bottom, #4a7c59 0%, #2d5a3d 100%);
            z-index: 1;
        }
        
        #tree {
            width: 50px;
            background: linear-gradient(to right, #5d4037 0%, #8d6e63 50%, #5d4037 100%);
            height: 100%;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: inset -5px 0 15px rgba(0,0,0,0.4);
            z-index: 2;
        }
        
        #lumberjack {
            width: 60px;
            height: 75px;
            position: absolute;
            bottom: 100px;
            left: 75px;
            transition: left 0.03s ease-out;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #keoneImg {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid #9c27b0;
            box-shadow: 0 0 15px rgba(156, 39, 176, 0.6);
            margin-bottom: -8px;
            position: relative;
            z-index: 2;
        }
        
        .lumberjack-body {
            width: 30px;
            height: 38px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-radius: 5px;
            position: relative;
            z-index: 1;
        }
        
        .lumberjack-body::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 18px;
            background: #3498db;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 0 0 3px 3px;
        }
        
        #axe {
            position: absolute;
            width: 40px;
            height: 40px;
            top: 15px;
            right: -20px;
            font-size: 32px;
            transition: transform 0.08s;
            z-index: 3;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
        }
        
        #axe.swing {
            animation: swingAxe 0.12s ease-out;
        }
        
        @keyframes swingAxe {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(-60deg); }
            100% { transform: rotate(0deg); }
        }
        
        .branch {
            position: absolute;
            z-index: 3;
        }
        
        .branch-main {
            width: 90px;
            height: 30px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .branch-connector {
            width: 35px;
            height: 22px;
            background: linear-gradient(to right, #5d4037, #27ae60);
            position: absolute;
            top: 4px;
        }
        
        .branch.left .branch-main { left: -60px; }
        .branch.left .branch-connector { left: 30px; }
        .branch.right .branch-main { right: -60px; }
        .branch.right .branch-connector { right: 30px; }
        
        .branch-leaves {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #2ecc71;
            border-radius: 50%;
            top: -5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .branch.left .branch-leaves:nth-child(1) { left: 10px; }
        .branch.left .branch-leaves:nth-child(2) { left: 35px; top: -8px; }
        .branch.left .branch-leaves:nth-child(3) { left: 60px; }
        .branch.right .branch-leaves:nth-child(1) { right: 10px; }
        .branch.right .branch-leaves:nth-child(2) { right: 35px; top: -8px; }
        .branch.right .branch-leaves:nth-child(3) { right: 60px; }
        
        /* Bottom HUD Container */
        #bottomHUD {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            z-index: 20;
        }
        
        #scoreDisplay {
            font-size: 32px;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 10px rgba(156, 39, 176, 0.9), 0 0 20px rgba(156, 39, 176, 0.6), 2px 2px 4px rgba(0,0,0,0.8);
            letter-spacing: 2px;
        }
        
        #timeBarContainer {
            width: 200px;
            height: 12px;
            background: rgba(0,0,0,0.7);
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid rgba(156, 39, 176, 0.6);
            box-shadow: 0 0 15px rgba(156, 39, 176, 0.3);
        }
        
        #timeBarFill {
            height: 100%;
            background: linear-gradient(to right, #00d2d3 0%, #54a0ff 100%);
            width: 100%;
            transition: width 0.1s linear, background 0.3s;
            border-radius: 4px;
        }
        
        /* Tap zones for mobile */
        .tap-zone {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            z-index: 30;
            cursor: pointer;
        }
        
        .tap-zone.left { left: 0; }
        .tap-zone.right { right: 0; }
        
        .tap-zone:active {
            background: rgba(255,255,255,0.1);
        }
        
        /* Side panel */
        #sidePanel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 280px;
        }
        
        .panel-section {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        
        button {
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        
        #wallet {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        #wallet:hover { transform: translateY(-2px); }
        #wallet.connected {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
        }
        
        .fund-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 10px 8px;
            font-size: 12px;
            flex: 1;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
        }
        
        .fund-btn:hover { transform: translateY(-2px); }
        
        #startBtn {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
            color: white;
            font-size: 20px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(245, 87, 108, 0.5);
        }
        
        #startBtn:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(245, 87, 108, 0.6);
        }
        
        #startBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #status {
            font-size: 13px;
            text-align: center;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #fundOptions {
            display: none;
            margin-top: 10px;
        }
        
        #burnerInfo {
            font-size: 11px;
            text-align: center;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            word-break: break-all;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        #burnerInfo:hover { background: rgba(0,0,0,0.5); }
        
        .instructions {
            font-size: 13px;
            line-height: 1.5;
            opacity: 0.8;
        }
        
        .instructions p { margin: 5px 0; }
        .highlight { color: #feca57; }
        
        /* Game Over Overlay */
        #gameOver {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            opacity: 0;
            animation: fadeInOverlay 0.5s ease-out forwards;
        }
        
        @keyframes fadeInOverlay {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        #gameOver h2 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #f5576c;
            opacity: 0;
            animation: slideDown 0.4s ease-out 0.3s forwards;
        }
        
        @keyframes slideDown {
            0% { opacity: 0; transform: translateY(-30px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        #gameOver.newRecord h2 {
            color: #feca57;
            text-shadow: 0 0 20px rgba(254, 202, 87, 0.8);
        }
        
        #finalScore {
            font-size: 64px;
            font-weight: bold;
            color: white;
            margin: 10px 0;
            text-shadow: 0 0 30px rgba(255,255,255,0.5);
            opacity: 0;
            animation: popIn 0.5s ease-out 0.5s forwards;
        }
        
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.5); }
            70% { transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        #txSummary {
            font-size: 18px;
            color: #9c27b0;
            margin: 10px 0;
            padding: 10px 20px;
            background: rgba(156, 39, 176, 0.2);
            border-radius: 20px;
            opacity: 0;
            animation: fadeIn 0.4s ease-out 0.7s forwards;
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        #beatScore {
            font-size: 14px;
            color: #feca57;
            margin: 10px 0;
            opacity: 0;
            animation: fadeIn 0.4s ease-out 0.8s forwards;
        }
        
        #restartBtn {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
            color: white;
            margin-top: 20px;
            font-size: 18px;
            padding: 15px 40px;
            width: auto;
            opacity: 0;
            animation: fadeIn 0.4s ease-out 1s forwards;
        }
        
        #txLink {
            margin-top: 15px;
        }
        
        #txLink a {
            color: #54a0ff;
            text-decoration: none;
        }
        
        /* Particles */
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 50;
            font-size: 20px;
        }
        
        /* Start overlay */
        #startOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        #startOverlay h2 {
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        #startOverlay p {
            font-size: 16px;
            opacity: 0.8;
            margin: 5px 0;
        }
        
        #tapToStart {
            margin-top: 20px;
            font-size: 18px;
            color: #feca57;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        #startOverlay.hidden { display: none; }
        
        @media (max-width: 750px) {
            #mainContainer {
                flex-direction: column;
                align-items: center;
            }
            #sidePanel {
                width: 380px;
                max-width: 100%;
            }
            h1 { font-size: 28px; }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>ü™ì MONAD LUMBERJACK</h1>
        <div id="highScoreDisplay">üèÜ Best: <span id="highScoreTop">0</span></div>
    </div>
    
    <div id="mainContainer">
        <div id="gameWrapper">
            <div id="gameArea">
                <div id="tree"></div>
                
                <div id="lumberjack">
                    <img src="keone.png" alt="Lumberjack" id="keoneImg">
                    <div class="lumberjack-body"></div>
                    <div id="axe">ü™ì</div>
                </div>
                <div id="ground"></div>
                
                <div id="bottomHUD">
                    <div id="scoreDisplay">0</div>
                    <div id="timeBarContainer">
                        <div id="timeBarFill"></div>
                    </div>
                </div>
                
                <div class="tap-zone left" id="tapLeft"></div>
                <div class="tap-zone right" id="tapRight"></div>
                
                <div id="startOverlay">
                    <h2>TAP TO CHOP</h2>
                    <p>‚¨ÖÔ∏è Left side = chop left</p>
                    <p>‚û°Ô∏è Right side = chop right</p>
                    <p>üåø Avoid the branches!</p>
                    <div id="tapToStart">CONNECT WALLET TO PLAY</div>
                </div>
                
                <div id="gameOver">
                    <h2>GAME OVER</h2>
                    <div id="finalScore">0</div>
                    <div id="txSummary">‚ö° 0 transactions</div>
                    <div id="beatScore"></div>
                    <div id="txLink"></div>
                    <button id="restartBtn">PRESS SPACE TO RETRY</button>
                </div>
            </div>
        </div>
        
        <div id="sidePanel">
            <div class="panel-section">
                <button id="wallet">Connect Wallet</button>
                <div id="fundOptions">
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        <button class="fund-btn" data-amount="1">1 MON</button>
                        <button class="fund-btn" data-amount="10">10 MON</button>
                        <button class="fund-btn" data-amount="100">100 MON</button>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="customAmount" placeholder="Custom" style="flex: 1; padding: 10px; border-radius: 8px; border: none; font-size: 14px; width: 70px;">
                        <button class="fund-btn" id="customFundBtn">Fund</button>
                    </div>
                </div>
                <div id="status">Connect wallet to play</div>
                <div id="burnerInfo"></div>
            </div>
            
            <div class="panel-section">
                <button id="startBtn" disabled>START GAME</button>
                <div style="font-size: 11px; text-align: center; opacity: 0.6; margin-top: 8px;">or press SPACE</div>
            </div>
            
            <div class="panel-section instructions">
                <p><strong>How to Play:</strong></p>
                <p>‚Ä¢ Tap <span class="highlight">left</span> or <span class="highlight">right</span> to chop</p>
                <p>‚Ä¢ Don't hit the branches!</p>
                <p>‚Ä¢ Every chop = 1 transaction ‚ö°</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        const CONTRACT_ADDRESS = "0x571044cf1Fd3a1cac6c2b06e4b6A08528dFF63F0";
        const CONTRACT_ABI = [
            "function startGame(address mainWallet) external",
            "function chop(address mainWallet, uint256 chopNumber) external",
            "function endGame(address mainWallet, uint256 finalScore) external",
            "function getHighScore(address player) external view returns (uint256)",
            "function totalChops() external view returns (uint256)"
        ];
        
        const MONAD_CHAIN_ID = '0x279f';
        const MONAD_RPC = 'https://testnet-rpc.monad.xyz';
        const MONAD_EXPLORER = 'https://testnet.monadexplorer.com';
        
        let score = 0;
        let highScore = 0;
        let gameActive = false;
        let lumberjackSide = 'left';
        let branches = [];
        let provider, signer, userAddress;
        let burnerWallet, burnerContract;
        let timeRemaining = 100;
        let baseTimeDecay = 0.15;
        let currentTimeDecay = 0.15;
        let timeAddPerChop = 5;
        let animationFrameId;
        let txCount = 0;
        let pendingTxs = [];
        let currentNonce = null;
        let txQueue = [];
        let isProcessingQueue = false;
        let canRestart = true;
        
        const $ = id => document.getElementById(id);
        const walletBtn = $('wallet');
        const fundOptionsDiv = $('fundOptions');
        const customAmountInput = $('customAmount');
        const customFundBtn = $('customFundBtn');
        const startBtn = $('startBtn');
        const statusDiv = $('status');
        const burnerInfoDiv = $('burnerInfo');
        const scoreDisplay = $('scoreDisplay');
        const timeBarFill = $('timeBarFill');
        const lumberjack = $('lumberjack');
        const keoneImg = $('keoneImg');
        const axe = $('axe');
        const gameArea = $('gameArea');
        const gameOverDiv = $('gameOver');
        const restartBtn = $('restartBtn');
        const finalScoreDiv = $('finalScore');
        const txSummaryDiv = $('txSummary');
        const beatScoreDiv = $('beatScore');
        const txLinkDiv = $('txLink');
        const highScoreDiv = $('highScoreTop');
        const startOverlay = $('startOverlay');
        const tapToStart = $('tapToStart');
        const tapLeft = $('tapLeft');
        const tapRight = $('tapRight');
        
        if (localStorage.getItem('monadLumberjackHighScore')) {
            highScore = parseInt(localStorage.getItem('monadLumberjackHighScore'));
            highScoreDiv.textContent = highScore;
        }
        
        function getOrCreateBurnerWallet() {
            let pk = localStorage.getItem('monadLumberjackBurner');
            if (!pk) {
                const newWallet = ethers.Wallet.createRandom();
                pk = newWallet.privateKey;
                localStorage.setItem('monadLumberjackBurner', pk);
            }
            const rpcProvider = new ethers.providers.JsonRpcProvider(MONAD_RPC);
            return new ethers.Wallet(pk, rpcProvider);
        }
        
        async function checkBurnerBalance() {
            if (!burnerWallet) return 0;
            const balance = await burnerWallet.getBalance();
            return parseFloat(ethers.utils.formatEther(balance));
        }
        
        walletBtn.addEventListener('click', async () => {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask!');
                return;
            }
            
            try {
                statusDiv.textContent = 'Connecting...';
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                const network = await provider.getNetwork();
                if (network.chainId !== 10143) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: MONAD_CHAIN_ID }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: MONAD_CHAIN_ID,
                                    chainName: 'Monad Testnet',
                                    nativeCurrency: { name: 'MON', symbol: 'MON', decimals: 18 },
                                    rpcUrls: [MONAD_RPC],
                                    blockExplorerUrls: [MONAD_EXPLORER]
                                }]
                            });
                        } else {
                            throw switchError;
                        }
                    }
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                }
                
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                burnerWallet = getOrCreateBurnerWallet();
                burnerContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, burnerWallet);
                
                walletBtn.textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                walletBtn.classList.add('connected');
                
                const burnerBalance = await checkBurnerBalance();
                burnerInfoDiv.style.display = 'block';
                burnerInfoDiv.innerHTML = `üéÆ Game Wallet:<br><strong>${burnerWallet.address}</strong><br>Balance: ${burnerBalance.toFixed(4)} MON`;
                burnerInfoDiv.onclick = () => {
                    navigator.clipboard.writeText(burnerWallet.address);
                    statusDiv.textContent = 'Copied!';
                    setTimeout(async () => {
                        const bal = await checkBurnerBalance();
                        statusDiv.textContent = bal < 0.01 ? 'Fund wallet to play' : `Ready! ${bal.toFixed(3)} MON`;
                    }, 1000);
                };
                
                fundOptionsDiv.style.display = 'block';
                
                if (burnerBalance < 0.01) {
                    statusDiv.textContent = 'Fund game wallet to play';
                    startBtn.disabled = true;
                    tapToStart.textContent = 'FUND WALLET TO PLAY';
                } else {
                    statusDiv.textContent = `Ready! ${burnerBalance.toFixed(3)} MON`;
                    startBtn.disabled = false;
                    tapToStart.textContent = 'TAP ANYWHERE TO START';
                }
                
            } catch (error) {
                console.error('Connection error:', error);
                statusDiv.textContent = 'Connection failed';
            }
        });
        
        async function fundBurnerWallet(amount) {
            try {
                statusDiv.textContent = 'Confirm in wallet...';
                const tx = await signer.sendTransaction({
                    to: burnerWallet.address,
                    value: ethers.utils.parseEther(amount.toString())
                });
                statusDiv.textContent = 'Funding...';
                await tx.wait();
                const burnerBalance = await checkBurnerBalance();
                statusDiv.textContent = `Ready! ${burnerBalance.toFixed(3)} MON`;
                burnerInfoDiv.innerHTML = `üéÆ Game Wallet:<br><strong>${burnerWallet.address}</strong><br>Balance: ${burnerBalance.toFixed(4)} MON`;
                startBtn.disabled = false;
                tapToStart.textContent = 'TAP ANYWHERE TO START';
            } catch (error) {
                console.error('Funding error:', error);
                statusDiv.textContent = 'Funding failed';
            }
        }
        
        document.querySelectorAll('.fund-btn[data-amount]').forEach(btn => {
            btn.addEventListener('click', () => fundBurnerWallet(btn.getAttribute('data-amount')));
        });
        
        customFundBtn.addEventListener('click', () => {
            const amount = parseFloat(customAmountInput.value);
            if (amount && amount > 0) fundBurnerWallet(amount);
        });
        
        async function processQueue() {
            if (isProcessingQueue) return;
            isProcessingQueue = true;
            
            while (txQueue.length > 0) {
                const chopNumber = txQueue.shift();
                try {
                    const tx = await burnerContract.chop(userAddress, chopNumber, { 
                        gasLimit: 100000,
                        nonce: currentNonce
                    });
                    currentNonce++;
                    pendingTxs.push(tx.hash);
                } catch (error) {
                    console.error('Chop tx error:', error);
                    if (error.message && error.message.includes('nonce')) {
                        currentNonce = await burnerWallet.getTransactionCount('pending');
                    }
                }
            }
            isProcessingQueue = false;
        }
        
        function sendChopTx(chopNumber) {
            txQueue.push(chopNumber);
            processQueue();
        }
        
        function spawnParticles(x, y) {
            for (let i = 0; i < 5; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.textContent = 'üçÉ';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                gameArea.appendChild(particle);
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = 50 + Math.random() * 100;
                const vx = Math.cos(angle) * velocity;
                const vy = Math.sin(angle) * velocity;
                
                let px = x, py = y, opacity = 1;
                const animate = () => {
                    px += vx * 0.02;
                    py += vy * 0.02 + 2;
                    opacity -= 0.03;
                    particle.style.left = px + 'px';
                    particle.style.top = py + 'px';
                    particle.style.opacity = opacity;
                    if (opacity > 0) requestAnimationFrame(animate);
                    else particle.remove();
                };
                requestAnimationFrame(animate);
            }
        }
        
        function startGame() {
            if (!burnerWallet || startBtn.disabled) return;
            if (gameOverDiv.style.display === 'flex' && !canRestart) return;
            
            score = 0;
            txCount = 0;
            pendingTxs = [];
            txQueue = [];
            isProcessingQueue = false;
            timeRemaining = 100;
            currentTimeDecay = baseTimeDecay;
            branches = [];
            lumberjackSide = 'left';
            gameActive = true;
            
            startOverlay.classList.add('hidden');
            gameOverDiv.style.display = 'none';
            startBtn.disabled = true;
            
            updateScore();
            updateTimeBar();
            generateBranches();
            updateLumberjackPosition();
            
            burnerWallet.getTransactionCount('pending').then(nonce => {
                currentNonce = nonce;
                burnerContract.startGame(userAddress, { gasLimit: 100000, nonce: currentNonce }).catch(console.error);
                currentNonce++;
            });
            
            gameLoop();
        }
        
        function gameLoop() {
            if (!gameActive) return;
            
            const milestones = Math.floor(score / 25);
            const speedMultiplier = 1 + (milestones * 0.1);
            currentTimeDecay = baseTimeDecay * speedMultiplier;
            
            timeRemaining -= currentTimeDecay;
            updateTimeBar();
            
            if (timeRemaining <= 0) {
                endGame();
                return;
            }
            animationFrameId = requestAnimationFrame(gameLoop);
        }
        
        function generateBranches() {
            document.querySelectorAll('.branch').forEach(b => b.remove());
            branches = [];
            for (let i = 0; i < 8; i++) {
                const side = Math.random() > 0.5 ? 'left' : 'right';
                const position = 200 + (i * 70);
                branches.push({ side, position });
                createBranch(side, position);
            }
        }
        
        function createBranch(side, position) {
            const branch = document.createElement('div');
            branch.className = `branch ${side}`;
            branch.style.bottom = `${position}px`;
            branch.style.left = '155px';
            
            const connector = document.createElement('div');
            connector.className = 'branch-connector';
            branch.appendChild(connector);
            
            const main = document.createElement('div');
            main.className = 'branch-main';
            for (let i = 0; i < 3; i++) {
                const leaf = document.createElement('div');
                leaf.className = 'branch-leaves';
                main.appendChild(leaf);
            }
            branch.appendChild(main);
            gameArea.appendChild(branch);
        }
        
        function updateLumberjackPosition() {
            if (lumberjackSide === 'left') {
                lumberjack.style.left = '75px';
                keoneImg.style.transform = 'scaleX(1)';
                axe.style.right = '-20px';
                axe.style.left = 'auto';
                axe.style.transform = 'scaleX(1)';
            } else {
                lumberjack.style.left = '245px';
                keoneImg.style.transform = 'scaleX(-1)';
                axe.style.left = '-20px';
                axe.style.right = 'auto';
                axe.style.transform = 'scaleX(-1)';
            }
        }
        
        function chop(side) {
            if (!gameActive) return;
            
            const lowestBranch = branches[0];
            if (lowestBranch && lowestBranch.position < 210 && lowestBranch.side === side) {
                endGame();
                return;
            }
            
            lumberjackSide = side;
            updateLumberjackPosition();
            
            axe.classList.remove('swing');
            void axe.offsetWidth;
            axe.classList.add('swing');
            
            if (branches.length > 0) {
                const branchEl = document.querySelector('.branch');
                if (branchEl) {
                    const rect = branchEl.getBoundingClientRect();
                    const gameRect = gameArea.getBoundingClientRect();
                    spawnParticles(rect.left - gameRect.left + 50, rect.top - gameRect.top + 15);
                }
                
                branches.shift();
                const branchEls = document.querySelectorAll('.branch');
                if (branchEls[0]) branchEls[0].remove();
                
                branches.forEach((branch, index) => {
                    branch.position -= 70;
                    const branchEl = branchEls[index + 1];
                    if (branchEl) branchEl.style.bottom = `${branch.position}px`;
                });
                
                const newSide = Math.random() > 0.5 ? 'left' : 'right';
                const newPosition = 200 + (branches.length * 70);
                branches.push({ side: newSide, position: newPosition });
                createBranch(newSide, newPosition);
            }
            
            score++;
            txCount++;
            timeRemaining = Math.min(100, timeRemaining + timeAddPerChop);
            
            updateScore();
            updateTimeBar();
            sendChopTx(score);
        }
        
        function updateScore() {
            scoreDisplay.textContent = score;
        }
        
        function updateTimeBar() {
            const pct = Math.max(0, timeRemaining);
            timeBarFill.style.width = `${pct}%`;
            
            if (pct > 60) {
                timeBarFill.style.background = 'linear-gradient(to right, #00d2d3 0%, #54a0ff 100%)';
            } else if (pct > 30) {
                timeBarFill.style.background = 'linear-gradient(to right, #feca57 0%, #ff9f43 100%)';
            } else {
                timeBarFill.style.background = 'linear-gradient(to right, #ff6b6b 0%, #ee5a6f 100%)';
            }
        }
        
        async function endGame() {
            gameActive = false;
            cancelAnimationFrame(animationFrameId);
            
            const isNewRecord = score > highScore;
            const finalScore = score;
            const finalTxCount = txCount;
            
            if (isNewRecord) {
                highScore = score;
                highScoreDiv.textContent = highScore;
                localStorage.setItem('monadLumberjackHighScore', highScore.toString());
                gameOverDiv.classList.add('newRecord');
                gameOverDiv.querySelector('h2').textContent = 'üéâ NEW RECORD!';
                beatScoreDiv.textContent = '';
            } else {
                gameOverDiv.classList.remove('newRecord');
                gameOverDiv.querySelector('h2').textContent = 'GAME OVER';
                const diff = highScore - score;
                beatScoreDiv.textContent = diff === 0 ? 'You tied your best!' : `${diff} away from your best`;
            }
            
            finalScoreDiv.textContent = finalScore;
            txSummaryDiv.textContent = `‚ö° ${finalTxCount} transactions on Monad`;
            txLinkDiv.innerHTML = '';
            gameOverDiv.style.display = 'flex';
            
            canRestart = false;
            setTimeout(() => { canRestart = true; }, 1000);
            
            startBtn.disabled = false;
            
            (async () => {
                try {
                    await new Promise(r => setTimeout(r, 300));
                    const freshNonce = await burnerWallet.getTransactionCount('pending');
                    const tx = await burnerContract.endGame(userAddress, finalScore, { 
                        gasLimit: 150000,
                        nonce: freshNonce
                    });
                    const receipt = await tx.wait();
                    txLinkDiv.innerHTML = `<a href="${MONAD_EXPLORER}/tx/${receipt.transactionHash}" target="_blank">View on Explorer ‚Üí</a>`;
                } catch (error) {
                    console.error('End game error:', error);
                }
                
                const burnerBalance = await checkBurnerBalance();
                burnerInfoDiv.innerHTML = `üéÆ Game Wallet:<br><strong>${burnerWallet.address}</strong><br>Balance: ${burnerBalance.toFixed(4)} MON`;
                statusDiv.textContent = `Ready! ${burnerBalance.toFixed(3)} MON`;
            })();
        }
        
        restartBtn.addEventListener('click', startGame);
        startBtn.addEventListener('click', startGame);
        
        document.addEventListener('keydown', (e) => {
            if (gameOverDiv.style.display === 'flex') {
                if (e.key === ' ' || e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    e.preventDefault();
                    startGame();
                }
            }
        });
        
        tapLeft.addEventListener('click', () => {
            if (!gameActive && !startBtn.disabled && !startOverlay.classList.contains('hidden')) {
                startGame();
            } else {
                chop('left');
            }
        });
        
        tapRight.addEventListener('click', () => {
            if (!gameActive && !startBtn.disabled && !startOverlay.classList.contains('hidden')) {
                startGame();
            } else {
                chop('right');
            }
        });
        
        tapLeft.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (!gameActive && !startBtn.disabled) startGame();
            else chop('left');
        });
        
        tapRight.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (!gameActive && !startBtn.disabled) startGame();
            else chop('right');
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ' || e.key === 'Spacebar') {
                e.preventDefault();
                if (!gameActive && !startBtn.disabled) startGame();
            }
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                if (!gameActive && !startBtn.disabled) startGame();
                else chop('left');
            }
            if (e.key === 'ArrowRight') {
                e.preventDefault();
                if (!gameActive && !startBtn.disabled) startGame();
                else chop('right');
            }
        });
    </script>
</body>
</html>
