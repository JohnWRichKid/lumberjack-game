<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Monad Lumberjack</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Arial Black', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
            user-select: none;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Cpath d='M30 5 L35 25 L55 30 L35 35 L30 55 L25 35 L5 30 L25 25 Z' fill='%236E54FF' fill-opacity='0.04'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }
        #header, #mainContainer { position: relative; z-index: 1; }
        #header { text-align: center; margin-bottom: 10px; }
        h1 {
            font-size: 36px;
            margin: 10px 0 5px 0;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        #highScoreDisplay { font-size: 16px; color: #feca57; }
        #mainContainer { display: flex; gap: 20px; align-items: flex-start; }
        #gameArea {
            background: linear-gradient(to bottom, #87CEEB 0%, #B0E0E6 100%);
            width: 380px;
            height: 640px;
            position: relative;
            border: 3px solid #5D4037;
            border-radius: 15px;
            overflow: hidden;
        }
        .cloud {
            position: absolute;
            background: rgba(255,255,255,0.9);
            border-radius: 50px;
            z-index: 1;
        }
        .cloud::before, .cloud::after {
            content: '';
            position: absolute;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
        }
        .cloud1 { width: 80px; height: 30px; top: 80px; left: 20px; }
        .cloud1::before { width: 40px; height: 40px; top: -20px; left: 15px; }
        .cloud1::after { width: 50px; height: 45px; top: -22px; left: 40px; }
        .cloud2 { width: 70px; height: 25px; top: 150px; right: 25px; }
        .cloud2::before { width: 35px; height: 35px; top: -18px; left: 12px; }
        .cloud2::after { width: 42px; height: 38px; top: -18px; left: 35px; }
        #ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100px;
            background: linear-gradient(to bottom, #7CB342 0%, #558B2F 50%, #33691E 100%);
            z-index: 5;
        }
        #groundTop {
            position: absolute;
            bottom: 100px;
            width: 100%;
            height: 15px;
            background: #8BC34A;
            border-radius: 50% 50% 0 0 / 100% 100% 0 0;
            z-index: 5;
        }
        #tree {
            width: 55px;
            background: linear-gradient(to right, #5D4037 0%, #8D6E63 35%, #A1887F 50%, #8D6E63 65%, #5D4037 100%);
            height: calc(100% - 100px);
            position: absolute;
            left: 50%;
            bottom: 100px;
            transform: translateX(-50%);
            z-index: 10;
        }
        #treeTop {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 11;
        }
        .tree-foliage {
            position: absolute;
            background: radial-gradient(ellipse at 50% 60%, #66BB6A 0%, #43A047 40%, #388E3C 70%, #2E7D32 100%);
            border-radius: 50%;
        }
        .tf1 { width: 100px; height: 70px; top: 0; left: -50px; }
        .tf2 { width: 70px; height: 55px; top: 35px; left: -65px; }
        .tf3 { width: 70px; height: 55px; top: 35px; left: -5px; }
        
        /* BRANCHES */
        .branch {
            position: absolute;
            z-index: 9;
            height: 60px;
            width: 100px;
        }
        .branch.left {
            right: calc(50% + 25px);
        }
        .branch.right {
            left: calc(50% + 25px);
        }
        /* Brown arm */
        .branch-arm {
            position: absolute;
            width: 50px;
            height: 14px;
            background: linear-gradient(to bottom, #A68B6A 0%, #8B7355 50%, #6D5A40 100%);
            top: 32px;
            border-radius: 6px;
        }
        .branch.left .branch-arm {
            right: 0;
            border-radius: 6px 0 0 6px;
        }
        .branch.right .branch-arm {
            left: 0;
            border-radius: 0 6px 6px 0;
        }
        /* Shrub - upward pointing bush */
        .branch-shrub {
            position: absolute;
            width: 50px;
            height: 45px;
            top: 0;
        }
        .branch.left .branch-shrub {
            left: 0;
        }
        .branch.right .branch-shrub {
            right: 0;
        }
        .shrub-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 44px;
            height: 30px;
            background: radial-gradient(ellipse at 50% 80%, #5CB85C 0%, #4CAF50 30%, #43A047 60%, #388E3C 100%);
            border-radius: 40% 40% 45% 45%;
        }
        .shrub-top {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 25px;
            background: radial-gradient(ellipse at 50% 70%, #6DC96D 0%, #5CB85C 40%, #4CAF50 100%);
            border-radius: 50% 50% 40% 40%;
        }
        .shrub-left {
            position: absolute;
            bottom: 8px;
            left: 0;
            width: 20px;
            height: 18px;
            background: radial-gradient(ellipse at 50% 70%, #5CB85C 0%, #43A047 100%);
            border-radius: 50%;
        }
        .shrub-right {
            position: absolute;
            bottom: 8px;
            right: 0;
            width: 20px;
            height: 18px;
            background: radial-gradient(ellipse at 50% 70%, #5CB85C 0%, #43A047 100%);
            border-radius: 50%;
        }

        /* Lumberjack */
        #lumberjack {
            width: 70px;
            height: 85px;
            position: absolute;
            bottom: 115px;
            z-index: 20;
            transition: left 0.05s ease-out;
        }
        #lumberjack.left { left: 55px; }
        #lumberjack.right { left: 255px; }
        #keoneImg {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #5D4037;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
            background: #FFCCBC;
            object-fit: cover;
        }
        .lumberjack-body {
            width: 35px;
            height: 40px;
            background: linear-gradient(to right, #C62828 0%, #E53935 50%, #C62828 100%);
            border-radius: 5px;
            position: absolute;
            top: 35px;
            left: 50%;
            transform: translateX(-50%);
        }
        .lumberjack-body::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 28px;
            height: 30px;
            background: repeating-linear-gradient(90deg, #C62828 0px, #C62828 3px, #212121 3px, #212121 6px);
            border-radius: 3px;
        }
        .lumberjack-legs {
            width: 30px;
            height: 20px;
            background: #1565C0;
            border-radius: 0 0 5px 5px;
            position: absolute;
            top: 72px;
            left: 50%;
            transform: translateX(-50%);
        }
        #axe {
            position: absolute;
            width: 40px;
            height: 40px;
            top: 25px;
            font-size: 32px;
            z-index: 3;
        }
        #lumberjack.left #axe { right: -5px; transform: scaleX(-1); }
        #lumberjack.right #axe { left: -5px; transform: scaleX(1); }
        #axe.swing { animation: swingAxe 0.1s ease-out; }
        @keyframes swingAxe {
            0%, 100% { rotate: 0deg; }
            50% { rotate: -45deg; }
        }
        
        /* HUD */
        #scoreDisplay {
            position: absolute;
            top: 55px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 42px;
            font-weight: bold;
            color: white;
            text-shadow: 3px 3px 0 #5D4037;
            z-index: 100;
        }
        #timeBarContainer {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 18px;
            background: rgba(0,0,0,0.3);
            border-radius: 9px;
            overflow: hidden;
            border: 3px solid #5D4037;
            z-index: 100;
        }
        #timeBarFill {
            height: 100%;
            background: linear-gradient(to right, #4CAF50, #8BC34A);
            width: 100%;
            transition: width 0.1s linear;
        }
        #timeBarFill.warning { background: linear-gradient(to right, #FF9800, #FFC107); }
        #timeBarFill.danger { background: linear-gradient(to right, #f44336, #FF5722); }
        
        .tap-zone {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            z-index: 30;
            cursor: pointer;
        }
        .tap-zone.left { left: 0; }
        .tap-zone.right { right: 0; }
        
        /* Side Panel */
        #sidePanel { display: flex; flex-direction: column; gap: 15px; width: 280px; }
        .panel-section {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
        }
        #wallet { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        #wallet.connected { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .fund-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 10px 8px; font-size: 12px; flex: 1; }
        #startBtn { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); color: white; font-size: 20px; padding: 15px; }
        #startBtn:disabled { opacity: 0.5; cursor: not-allowed; }
        #status { font-size: 13px; text-align: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; min-height: 40px; display: flex; align-items: center; justify-content: center; }
        #fundOptions { display: none; margin-top: 10px; }
        #burnerInfo { font-size: 11px; text-align: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; margin-top: 10px; display: none; word-break: break-all; cursor: pointer; }
        .instructions { font-size: 13px; line-height: 1.5; opacity: 0.8; }
        .instructions p { margin: 5px 0; }
        .highlight { color: #feca57; }
        #withdrawSection { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        
        /* Overlays */
        #startOverlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #startOverlay.hidden { display: none; }
        #startOverlay h2 { font-size: 24px; margin-bottom: 15px; }
        #startOverlay p { font-size: 16px; opacity: 0.8; margin: 5px 0; }
        #tapToStart { margin-top: 20px; font-size: 18px; color: #feca57; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
        
        #gameOver {
            display: none;
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        #gameOver h2 { font-size: 28px; margin-bottom: 10px; color: #f5576c; }
        #gameOver.newRecord h2 { color: #feca57; }
        #finalScore { font-size: 64px; font-weight: bold; color: white; margin: 10px 0; }
        #txSummary { font-size: 18px; color: #9c27b0; margin: 10px 0; padding: 10px 20px; background: rgba(156,39,176,0.2); border-radius: 20px; }
        #beatScore { font-size: 14px; color: #feca57; margin: 10px 0; }
        #restartBtn { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); color: white; margin-top: 20px; font-size: 18px; padding: 15px 40px; width: auto; }
        #txLink { margin-top: 15px; }
        #txLink a { color: #54a0ff; text-decoration: none; }
        
        @media (max-width: 750px) {
            #mainContainer { flex-direction: column; align-items: center; }
            #sidePanel { width: 380px; max-width: 100%; }
            h1 { font-size: 28px; }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>ü™ì MONAD LUMBERJACK</h1>
        <div id="highScoreDisplay">üèÜ Best: <span id="highScoreTop">0</span></div>
    </div>
    
    <div id="mainContainer">
        <div id="gameArea">
            <div class="cloud cloud1"></div>
            <div class="cloud cloud2"></div>
            
            <div id="timeBarContainer"><div id="timeBarFill"></div></div>
            <div id="scoreDisplay">0</div>
            
            <div id="treeTop">
                <div class="tree-foliage tf1"></div>
                <div class="tree-foliage tf2"></div>
                <div class="tree-foliage tf3"></div>
            </div>
            <div id="tree"></div>
            
            <div id="lumberjack" class="left">
                <img src="keone.png" alt="" id="keoneImg" onerror="this.style.background='#FFCCBC'">
                <div class="lumberjack-body"></div>
                <div class="lumberjack-legs"></div>
                <div id="axe">ü™ì</div>
            </div>
            
            <div id="groundTop"></div>
            <div id="ground"></div>
            
            <div class="tap-zone left" id="tapLeft"></div>
            <div class="tap-zone right" id="tapRight"></div>
            
            <div id="startOverlay">
                <h2>TAP TO CHOP</h2>
                <p>‚¨ÖÔ∏è Left = move left & chop</p>
                <p>‚û°Ô∏è Right = move right & chop</p>
                <p>üåø Avoid branches!</p>
                <div id="tapToStart">CONNECT WALLET TO PLAY</div>
            </div>
            
            <div id="gameOver">
                <h2>GAME OVER</h2>
                <div id="finalScore">0</div>
                <div id="txSummary">‚ö° 0 transactions</div>
                <div id="beatScore"></div>
                <div id="txLink"></div>
                <button id="restartBtn">PLAY AGAIN</button>
            </div>
        </div>
        
        <div id="sidePanel">
            <div class="panel-section">
                <button id="wallet">Connect Wallet</button>
                <div id="fundOptions">
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        <button class="fund-btn" data-amount="1">1 MON</button>
                        <button class="fund-btn" data-amount="10">10 MON</button>
                        <button class="fund-btn" data-amount="100">100 MON</button>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="customAmount" placeholder="Custom" style="flex:1; padding:10px; border-radius:8px; border:none; font-size:14px;">
                        <button class="fund-btn" id="customFundBtn">Fund</button>
                    </div>
                </div>
                <div id="status">Connect wallet to play</div>
                <div id="burnerInfo"></div>
                <div id="withdrawSection">
                    <div style="font-size:11px; margin-bottom:6px; opacity:0.8;">Withdraw MON:</div>
                    <input type="text" id="withdrawAddress" placeholder="Address (0x...)" style="width:100%; padding:8px; border-radius:6px; border:none; font-size:11px; margin-bottom:6px;">
                    <div style="display:flex; gap:6px;">
                        <input type="number" id="withdrawAmount" placeholder="Amount" style="flex:1; padding:8px; border-radius:6px; border:none; font-size:11px;">
                        <button id="withdrawBtn" style="padding:8px 12px; font-size:11px; background:linear-gradient(135deg,#e74c3c,#c0392b); color:white; border:none; border-radius:6px; cursor:pointer;">Withdraw</button>
                    </div>
                </div>
            </div>
            
            <div class="panel-section">
                <button id="startBtn" disabled>START GAME</button>
                <div style="font-size:11px; text-align:center; opacity:0.6; margin-top:8px;">or press SPACE</div>
            </div>
            
            <div class="panel-section instructions">
                <p><strong>How to Play:</strong></p>
                <p>‚Ä¢ Tap <span class="highlight">left</span> or <span class="highlight">right</span></p>
                <p>‚Ä¢ Stay away from branches!</p>
                <p>‚Ä¢ Every chop = 1 tx ‚ö°</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        const CONTRACT = "0x571044cf1Fd3a1cac6c2b06e4b6A08528dFF63F0";
        const ABI = ["function startGame(address) external","function chop(address,uint256) external","function endGame(address,uint256) external"];
        const CHAIN_ID = '0x279f', RPC = 'https://testnet-rpc.monad.xyz', EXPLORER = 'https://testnet.monadexplorer.com';
        
        let score=0, highScore=0, gameActive=false, playerSide='left', branches=[], timeLeft=100, txCount=0, nonce=null, chopCount=0;
        let provider, signer, userAddress, burner, contract, animFrame;
        
        const $=id=>document.getElementById(id);
        const gameArea=$('gameArea'), scoreDisplay=$('scoreDisplay'), timeBar=$('timeBarFill');
        const lumberjack=$('lumberjack'), axe=$('axe'), startOverlay=$('startOverlay');
        const gameOver=$('gameOver'), startBtn=$('startBtn'), walletBtn=$('wallet');
        const statusDiv=$('status'), burnerInfo=$('burnerInfo'), fundOptions=$('fundOptions');
        const tapToStart=$('tapToStart'), highScoreEl=$('highScoreTop'), withdrawSection=$('withdrawSection');
        
        highScore = parseInt(localStorage.getItem('lumberjackHS')||'0');
        highScoreEl.textContent = highScore;
        
        function getBurner() {
            let pk = localStorage.getItem('lumberjackPK');
            if (!pk) { pk = ethers.Wallet.createRandom().privateKey; localStorage.setItem('lumberjackPK', pk); }
            return new ethers.Wallet(pk, new ethers.providers.JsonRpcProvider(RPC));
        }
        
        async function getBalance() {
            if (!burner) return 0;
            return parseFloat(ethers.utils.formatEther(await burner.getBalance()));
        }
        
        walletBtn.onclick = async () => {
            if (!window.ethereum) { alert('Install MetaMask!'); return; }
            try {
                statusDiv.textContent = 'Connecting...';
                await window.ethereum.request({method:'eth_requestAccounts'});
                provider = new ethers.providers.Web3Provider(window.ethereum);
                const net = await provider.getNetwork();
                if (net.chainId !== 10143) {
                    try { await window.ethereum.request({method:'wallet_switchEthereumChain',params:[{chainId:CHAIN_ID}]}); }
                    catch(e) { if(e.code===4902) await window.ethereum.request({method:'wallet_addEthereumChain',params:[{chainId:CHAIN_ID,chainName:'Monad Testnet',nativeCurrency:{name:'MON',symbol:'MON',decimals:18},rpcUrls:[RPC]}]}); }
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                }
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                burner = getBurner();
                contract = new ethers.Contract(CONTRACT, ABI, burner);
                
                walletBtn.textContent = userAddress.slice(0,6)+'...'+userAddress.slice(-4);
                walletBtn.classList.add('connected');
                
                const bal = await getBalance();
                burnerInfo.style.display = 'block';
                burnerInfo.innerHTML = `üéÆ Game Wallet:<br><b>${burner.address}</b><br>Balance: ${bal.toFixed(4)} MON`;
                burnerInfo.onclick = () => { navigator.clipboard.writeText(burner.address); statusDiv.textContent='Copied!'; };
                
                fundOptions.style.display = 'block';
                withdrawSection.style.display = 'block';
                
                if (bal < 0.01) {
                    statusDiv.textContent = 'Fund wallet to play';
                    startBtn.disabled = true;
                    tapToStart.textContent = 'FUND WALLET TO PLAY';
                } else {
                    statusDiv.textContent = `Ready! ${bal.toFixed(3)} MON`;
                    startBtn.disabled = false;
                    tapToStart.textContent = 'TAP TO START';
                }
            } catch(e) { console.error(e); statusDiv.textContent='Failed'; }
        };
        
        async function fund(amt) {
            try {
                statusDiv.textContent = 'Confirm...';
                const tx = await signer.sendTransaction({to:burner.address, value:ethers.utils.parseEther(amt.toString())});
                statusDiv.textContent = 'Funding...';
                await tx.wait();
                const bal = await getBalance();
                statusDiv.textContent = `Ready! ${bal.toFixed(3)} MON`;
                burnerInfo.innerHTML = `üéÆ Game Wallet:<br><b>${burner.address}</b><br>Balance: ${bal.toFixed(4)} MON`;
                startBtn.disabled = false;
                tapToStart.textContent = 'TAP TO START';
            } catch(e) { statusDiv.textContent='Failed'; }
        }
        
        document.querySelectorAll('.fund-btn[data-amount]').forEach(b => b.onclick = () => fund(b.dataset.amount));
        $('customFundBtn').onclick = () => { const a=parseFloat($('customAmount').value); if(a>0) fund(a); };
        
        $('withdrawBtn').onclick = async () => {
            const addr=$('withdrawAddress').value.trim(), amt=parseFloat($('withdrawAmount').value);
            if(!addr||!amt) return;
            try {
                statusDiv.textContent='Withdrawing...';
                await (await burner.sendTransaction({to:addr,value:ethers.utils.parseEther(amt.toString()),gasLimit:21000})).wait();
                const bal = await getBalance();
                burnerInfo.innerHTML = `üéÆ Game Wallet:<br><b>${burner.address}</b><br>Balance: ${bal.toFixed(4)} MON`;
                statusDiv.textContent = `Done! ${bal.toFixed(3)} MON`;
            } catch(e) { statusDiv.textContent='Failed'; }
        };
        
        function createBranch(side, y) {
            const el = document.createElement('div');
            el.className = 'branch ' + side;
            el.style.bottom = y + 'px';
            el.innerHTML = `
                <div class="branch-shrub">
                    <div class="shrub-top"></div>
                    <div class="shrub-base"></div>
                    <div class="shrub-left"></div>
                    <div class="shrub-right"></div>
                </div>
                <div class="branch-arm"></div>
            `;
            gameArea.appendChild(el);
            return el;
        }
        
        function initBranches() {
            document.querySelectorAll('.branch').forEach(b=>b.remove());
            branches = [];
            for (let i=0; i<6; i++) {
                const side = Math.random()>0.5 ? 'left' : 'right';
                const y = 180 + i*75;
                branches.push({side, y, el: createBranch(side, y)});
            }
        }
        
        function startGame() {
            if (!burner || startBtn.disabled) return;
            
            score=0; txCount=0; timeLeft=100; playerSide='left'; gameActive=true; chopCount=0;
            
            startOverlay.classList.add('hidden');
            gameOver.style.display = 'none';
            startBtn.disabled = true;
            
            scoreDisplay.textContent = '0';
            timeBar.style.width = '100%';
            timeBar.className = '';
            lumberjack.className = 'left';
            
            initBranches();
            
            burner.getTransactionCount('pending').then(n => {
                nonce = n;
                contract.startGame(userAddress, {gasLimit:100000, nonce}).catch(console.error);
                nonce++;
            });
            
            requestAnimationFrame(gameLoop);
        }
        
        function gameLoop() {
            if (!gameActive) return;
            
            const decay = 0.12 * (1 + Math.floor(score/25)*0.15);
            timeLeft -= decay;
            
            const pct = Math.max(0, timeLeft);
            timeBar.style.width = pct + '%';
            timeBar.className = pct > 50 ? '' : pct > 25 ? 'warning' : 'danger';
            
            if (timeLeft <= 0) { endGame(); return; }
            animFrame = requestAnimationFrame(gameLoop);
        }
        
        function chop(side) {
            if (!gameActive) return;
            
            playerSide = side;
            lumberjack.className = side;
            
            axe.classList.remove('swing');
            void axe.offsetWidth;
            axe.classList.add('swing');
            
            // Die if on same side as branch
            if (branches[0] && branches[0].side === side) {
                endGame();
                return;
            }
            
            score++;
            txCount++;
            chopCount++;
            timeLeft = Math.min(100, timeLeft + 4);
            scoreDisplay.textContent = score;
            
            // Every 2 chops, remove bottom branch and add new one
            if (chopCount >= 2) {
                chopCount = 0;
                
                branches[0].el.remove();
                branches.shift();
                
                branches.forEach(b => {
                    b.y -= 75;
                    b.el.style.bottom = b.y + 'px';
                });
                
                const newSide = Math.random() > 0.5 ? 'left' : 'right';
                const newY = 180 + 5*75;
                branches.push({side: newSide, y: newY, el: createBranch(newSide, newY)});
            }
            
            contract.chop(userAddress, score, {gasLimit:100000, nonce}).catch(console.error);
            nonce++;
        }
        
        function endGame() {
            gameActive = false;
            cancelAnimationFrame(animFrame);
            
            const isRecord = score > highScore;
            if (isRecord) {
                highScore = score;
                localStorage.setItem('lumberjackHS', highScore);
                highScoreEl.textContent = highScore;
            }
            
            $('finalScore').textContent = score;
            $('txSummary').textContent = `‚ö° ${txCount} transactions`;
            $('beatScore').textContent = isRecord ? 'üéâ NEW RECORD!' : `Best: ${highScore}`;
            gameOver.className = isRecord ? 'newRecord' : '';
            gameOver.querySelector('h2').textContent = isRecord ? 'üéâ NEW RECORD!' : 'GAME OVER';
            gameOver.style.display = 'flex';
            
            startBtn.disabled = false;
            
            (async () => {
                try {
                    const n = await burner.getTransactionCount('pending');
                    const tx = await contract.endGame(userAddress, score, {gasLimit:150000, nonce:n});
                    const r = await tx.wait();
                    $('txLink').innerHTML = `<a href="${EXPLORER}/tx/${r.transactionHash}" target="_blank">View on Explorer ‚Üí</a>`;
                } catch(e) {}
                const bal = await getBalance();
                burnerInfo.innerHTML = `üéÆ Game Wallet:<br><b>${burner.address}</b><br>Balance: ${bal.toFixed(4)} MON`;
            })();
        }
        
        $('restartBtn').onclick = startGame;
        startBtn.onclick = startGame;
        
        $('tapLeft').onclick = () => { if(!gameActive && !startBtn.disabled) startGame(); else chop('left'); };
        $('tapRight').onclick = () => { if(!gameActive && !startBtn.disabled) startGame(); else chop('right'); };
        $('tapLeft').ontouchstart = e => { e.preventDefault(); if(!gameActive && !startBtn.disabled) startGame(); else chop('left'); };
        $('tapRight').ontouchstart = e => { e.preventDefault(); if(!gameActive && !startBtn.disabled) startGame(); else chop('right'); };
        
        document.onkeydown = e => {
            if (e.key===' '||e.key==='ArrowLeft'||e.key==='ArrowRight') e.preventDefault();
            if (gameOver.style.display==='flex' && (e.key===' '||e.key==='ArrowLeft'||e.key==='ArrowRight')) { startGame(); return; }
            if (e.key===' ' && !gameActive && !startBtn.disabled) startGame();
            if (e.key==='ArrowLeft') { if(!gameActive && !startBtn.disabled) startGame(); else chop('left'); }
            if (e.key==='ArrowRight') { if(!gameActive && !startBtn.disabled) startGame(); else chop('right'); }
        };
    </script>
</body>
</html>
